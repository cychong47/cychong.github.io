<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Keep calm and write something"><meta property="og:type" content="article"><meta property="og:image" content="https://cychong47.github.io/images/another_blog_bg.jpg"><meta property="twitter:image" content="https://cychong47.github.io/images/another_blog_bg.jpg"><meta name=title content="Setup Ghost in microk8s"><meta property="og:title" content="Setup Ghost in microk8s"><meta property="twitter:title" content="Setup Ghost in microk8s"><meta name=description content><meta property="og:description" content><meta property="twitter:description" content><meta property="twitter:card" content="summary"><meta name=keyword content="Blog, cychong, Kubernetes, dpdk"><link rel="shortcut icon" href=/img/favicon.ico><title>Setup Ghost in microk8s-another blog</title><link rel=canonical href=/post/2019/setup-ghost-in-microk8s-2/><link rel=stylesheet href=/css/iDisqus.min.css><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hux-blog.min.css><link rel=stylesheet href=/css/zanshang.css><link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://cychong47.github.io/css/custom-cleanwhite.css><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/hux-blog.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=/>Keep calm and write something</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>Home</a></li><li><a href=/categories/book>book</a></li><li><a href=/categories/gadget>gadget</a></li><li><a href=/categories/hugo>hugo</a></li><li><a href=/categories/kubernetes>kubernetes</a></li><li><a href=/categories/life>life</a></li><li><a href=/categories/note>note</a></li><li><a href=/categories/til>til</a></li><li><a href=/search>SEARCH <img src=/img/search.png height=15 style=cursor:pointer alt=Search></a></li></ul></div></div></div></nav><script>var $body=document.body;var $toggle=document.querySelector('.navbar-toggle');var $navbar=document.querySelector('#huxblog_navbar');var $collapse=document.querySelector('.navbar-collapse');$toggle.addEventListener('click',handleMagic)
function handleMagic(e){if($navbar.className.indexOf('in')>0){$navbar.className=" ";setTimeout(function(){if($navbar.className.indexOf('in')<0){$collapse.style.height="0px"}},400)}else{$collapse.style.height="auto"
$navbar.className+=" in";}}</script><style type=text/css>header.intro-header{background-image:url(/images/another_blog_bg.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/ghost title=ghost>ghost</a>
<a class=tag href=/tags/kubernetes title=kubernetes>kubernetes</a>
<a class=tag href=/tags/microk8s title=microk8s>microk8s</a></div><h1>Setup Ghost in microk8s</h1><h2 class=subheading></h2><span class=meta>Posted by
Chaeyong Chong
on
Monday, May 20, 2019<br>Last Modified on Monday, October 7, 2019</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-11 col-lg-offset-1
col-md-10 col-md-offset-1
post-container"><header><h2>TOC</h2></header><nav id=TableOfContents><ul><li><a href=#install-microk8s>Install microk8s</a><ul><li><a href=#enable-servicesmicrok8s>Enable services(microk8s)</a></li><li><a href=#basic-kubectl-commands>Basic kubectl commands</a></li></ul></li><li><a href=#example>Example.</a><ul><li><a href=#ngnix-container-replicaset을-만들고-service로-expose>Ngnix container replicaset을 만들고 service로 expose</a></li></ul></li><li><a href=#setup-ghost>Setup Ghost</a><ul><li><a href=#setup-volume>Setup volume</a></li><li><a href=#volume-claim>Volume Claim</a></li><li><a href=#deploy>Deploy</a></li><li><a href=#service>Service</a></li><li><a href=#github>github</a></li></ul></li></ul></nav><h1 id=install-microk8s>Install microk8s</h1><p><a href=https://microk8s.io/>MicroK8s - Fast, Light, Upstream Developer Kubernetes</a></p><p>설치는 위 링크에 있는 공식 홈페이지에 있는 대로 <code>snap</code> 명령어 하나로 간단하게 설치할 수 있다.</p><pre><code>cychong@mini1:~$ sudo snap install microk8s --classic
2019-05-18T09:43:53+09:00 INFO Waiting for restart...
microk8s v1.14.1 from Canonical✓ installed
</code></pre><p>설치된 <code>microk8s</code>의 정보를 확인하려면 <code>snap info microk8s</code></p><pre><code>cychong@mini1:~$ sudo snap info microk8s
name:      microk8s
summary:   Kubernetes for workstations and appliances
publisher: Canonical✓
contact:   &lt;https://github.com/ubuntu/microk8s&gt;
license:   unset
description: |
  MicroK8s is a small, fast, secure, single node Kubernetes that installs on just about any Linux
  box. Use it for offline development, prototyping, testing, or use it on a VM as a small, cheap,
  reliable k8s for CI/CD. It's also a great k8s for appliances - develop your IoT apps for k8s and
  deploy them to MicroK8s on your boxes.
commands:
  - microk8s.config
  - microk8s.ctr
  - microk8s.disable
  - microk8s.enable
  - microk8s.inspect
  - microk8s.istioctl
  - microk8s.kubectl
  - microk8s.reset
  - microk8s.start
  - microk8s.status
  - microk8s.stop
services:
  microk8s.daemon-apiserver:          simple, enabled, active
  microk8s.daemon-apiserver-kicker:   simple, enabled, active
  microk8s.daemon-containerd:         simple, enabled, active
  microk8s.daemon-controller-manager: simple, enabled, active
  microk8s.daemon-etcd:               simple, enabled, active
  microk8s.daemon-kubelet:            simple, enabled, active
  microk8s.daemon-proxy:              simple, enabled, active
  microk8s.daemon-scheduler:          simple, enabled, active
snap-id:      EaXqgt1lyCaxKaQCU349mlodBkDCXRcg
tracking:     stable
refresh-date: today at 09:44 KST
channels:
  stable:         v1.14.1         2019-04-18 (522) 214MB classic
  candidate:      v1.14.1         2019-04-15 (522) 214MB classic
  beta:           v1.14.1         2019-04-15 (522) 214MB classic
  edge:           v1.14.2         2019-05-17 (604) 217MB classic
  1.15/stable:    –
  1.15/candidate: –
  1.15/beta:      –
  1.15/edge:      v1.15.0-alpha.3 2019-05-08 (578) 215MB classic
  1.14/stable:    v1.14.1         2019-04-18 (521) 214MB classic
  1.14/candidate: v1.14.1         2019-04-15 (521) 214MB classic
  1.14/beta:      v1.14.1         2019-04-15 (521) 214MB classic
  1.14/edge:      v1.14.2         2019-05-17 (603) 217MB classic
  1.13/stable:    v1.13.5         2019-04-22 (526) 237MB classic
  1.13/candidate: v1.13.6         2019-05-09 (581) 237MB classic
  1.13/beta:      v1.13.6         2019-05-09 (581) 237MB classic
  1.13/edge:      v1.13.6         2019-05-08 (581) 237MB classic
  1.12/stable:    v1.12.8         2019-05-02 (547) 259MB classic
  1.12/candidate: v1.12.8         2019-05-01 (547) 259MB classic
  1.12/beta:      v1.12.8         2019-05-01 (547) 259MB classic
  1.12/edge:      v1.12.8         2019-04-24 (547) 259MB classic
  1.11/stable:    v1.11.10        2019-05-10 (557) 258MB classic
  1.11/candidate: v1.11.10        2019-05-02 (557) 258MB classic
  1.11/beta:      v1.11.10        2019-05-02 (557) 258MB classic
  1.11/edge:      v1.11.10        2019-05-01 (557) 258MB classic
  1.10/stable:    v1.10.13        2019-04-22 (546) 222MB classic
  1.10/candidate: v1.10.13        2019-04-22 (546) 222MB classic
  1.10/beta:      v1.10.13        2019-04-22 (546) 222MB classic
  1.10/edge:      v1.10.13        2019-04-22 (546) 222MB classic
installed:        v1.14.1                    (522) 214MB classic
</code></pre><h2 id=enable-servicesmicrok8s>Enable services(microk8s)</h2><pre><code>cychong@mini1:~$ sudo microk8s.enable dashboard registry dns
Enabling dashboard
secret/kubernetes-dashboard-certs created
serviceaccount/kubernetes-dashboard created
deployment.apps/kubernetes-dashboard created
service/kubernetes-dashboard created
service/monitoring-grafana created
service/monitoring-influxdb created
service/heapster created
deployment.extensions/monitoring-influxdb-grafana-v4 created
serviceaccount/heapster created
configmap/heapster-config created
configmap/eventer-config created
deployment.extensions/heapster-v1.5.2 created
dashboard enabled
Enabling the private registry
Enabling default storage class
deployment.extensions/hostpath-provisioner created
storageclass.storage.k8s.io/microk8s-hostpath created
Storage will be available soon
Applying registry manifest
namespace/container-registry created
persistentvolumeclaim/registry-claim created
deployment.extensions/registry created
service/registry created
The registry is enabled
Enabling DNS
Applying manifest
service/kube-dns created
serviceaccount/kube-dns created
configmap/kube-dns created
deployment.extensions/kube-dns created
Restarting kubelet
DNS is enabled
</code></pre><p>서비스 상태는 <code>microk8s.status</code>로 확인 가능</p><pre><code>cychong@mini1:~$ sudo microk8s.status
[sudo] password for cychong:
microk8s is running
addons:
jaeger: disabled
fluentd: disabled
gpu: disabled
storage: enabled
registry: enabled
ingress: disabled
dns: enabled
metrics-server: disabled
prometheus: disabled
istio: disabled
dashboard: enabled
</code></pre><h2 id=basic-kubectl-commands>Basic kubectl commands</h2><h3 id=node-상태-확인>Node 상태 확인</h3><pre><code>cychong@mini1:~$ sudo microk8s.kubectl get node
NAME STATUS ROLES AGE VERSION
mini1 Ready &lt;none&gt; 13m v1.14.1
</code></pre><h3 id=namespace-상태-확인>namespace 상태 확인</h3><pre><code>cychong@mini1:~$ sudo microk8s.kubectl get namespace
NAME                 STATUS   AGE
container-registry   Active   179m
default              Active   3h2m
kube-node-lease      Active   3h2m
kube-public          Active   3h2m
kube-system          Active   3h2m
</code></pre><h3 id=heading></h3><pre><code>cychong@mini1:~$ sudo microk8s.kubectl get all
NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.152.183.1   &lt;none&gt;        443/TCP   15m
</code></pre><p>모든 namespace를 보고 싶을 때</p><pre><code>cychong@mini1:~$ sudo microk8s.kubectl get all --all-namespaces
NAMESPACE            NAME                                                  READY   STATUS        RESTARTS   AGE
container-registry   pod/registry-7d65c894c-z5nv6                          1/1     Running       0          12m
kube-system          pod/heapster-v1.5.2-5c5498f57c-wztz5                  4/4     Terminating   0          12m
kube-system          pod/heapster-v1.5.2-6b5d7b57f9-4q9rd                  4/4     Running       0          10m
kube-system          pod/heapster-v1.5.2-89b48dff-g9hqj                    4/4     Terminating   0          10m
kube-system          pod/hostpath-provisioner-6d744c4f7c-gxksl             1/1     Running       0          12m
kube-system          pod/kube-dns-6bfbdd666c-t6f74                         3/3     Running       0          12m
kube-system          pod/kubernetes-dashboard-6fd7f9c494-48dnz             1/1     Running       0          12m
kube-system          pod/monitoring-influxdb-grafana-v4-78777c64c8-c5jk4   2/2     Running       0          12m

NAMESPACE            NAME                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
container-registry   service/registry               NodePort    10.152.183.138   &lt;none&gt;        5000:32000/TCP      12m
default              service/kubernetes             ClusterIP   10.152.183.1     &lt;none&gt;        443/TCP             15m
kube-system          service/heapster               ClusterIP   10.152.183.196   &lt;none&gt;        80/TCP              12m
kube-system          service/kube-dns               ClusterIP   10.152.183.10    &lt;none&gt;        53/UDP,53/TCP       12m
kube-system          service/kubernetes-dashboard   ClusterIP   10.152.183.236   &lt;none&gt;        443/TCP             12m
kube-system          service/monitoring-grafana     ClusterIP   10.152.183.146   &lt;none&gt;        80/TCP              12m
kube-system          service/monitoring-influxdb    ClusterIP   10.152.183.137   &lt;none&gt;        8083/TCP,8086/TCP   12m

NAMESPACE            NAME                                             READY   UP-TO-DATE   AVAILABLE   AGE
container-registry   deployment.apps/registry                         1/1     1            1           12m
kube-system          deployment.apps/heapster-v1.5.2                  1/1     1            1           12m
kube-system          deployment.apps/hostpath-provisioner             1/1     1            1           12m
kube-system          deployment.apps/kube-dns                         1/1     1            1           12m
kube-system          deployment.apps/kubernetes-dashboard             1/1     1            1           12m
kube-system          deployment.apps/monitoring-influxdb-grafana-v4   1/1     1            1           12m

NAMESPACE            NAME                                                        DESIRED   CURRENT   READY   AGE
container-registry   replicaset.apps/registry-7d65c894c                          1         1         1       12m
kube-system          replicaset.apps/heapster-v1.5.2-5c5498f57c                  0         0         0       12m
kube-system          replicaset.apps/heapster-v1.5.2-6b5d7b57f9                  1         1         1       10m
kube-system          replicaset.apps/heapster-v1.5.2-89b48dff                    0         0         0       10m
kube-system          replicaset.apps/hostpath-provisioner-6d744c4f7c             1         1         1       12m
kube-system          replicaset.apps/kube-dns-6bfbdd666c                         1         1         1       12m
kube-system          replicaset.apps/kubernetes-dashboard-6fd7f9c494             1         1         1       12m
kube-system          replicaset.apps/monitoring-influxdb-grafana-v4-78777c64c8   1         1         1       12m
</code></pre><h3 id=system-pod-확인>System Pod 확인</h3><p><code>namespace</code>를 kube-system으로 지정하면 됨. <code>namespace</code>는 <code>microk8s.kubectl get all --all-namespaces</code> 명령의 출력에 나오는 NAMESPACE에서 알 수 있음</p><pre><code>cychong@mini1:~$ sudo microk8s.kubectl get pod
No resources found.

cychong@mini1:~$ sudo microk8s.kubectl get pod --namespace=kube-system
NAME                                              READY   STATUS        RESTARTS   AGE
heapster-v1.5.2-5c5498f57c-wztz5                  4/4     Terminating   0          16m
heapster-v1.5.2-6b5d7b57f9-4q9rd                  4/4     Running       0          15m
heapster-v1.5.2-89b48dff-g9hqj                    4/4     Terminating   0          15m
hostpath-provisioner-6d744c4f7c-gxksl             1/1     Running       0          16m
kube-dns-6bfbdd666c-t6f74                         3/3     Running       0          16m
kubernetes-dashboard-6fd7f9c494-48dnz             1/1     Running       0          16m
monitoring-influxdb-grafana-v4-78777c64c8-c5jk4   2/2     Running       0          16m
</code></pre><p>특정 pod에 대한 정보만 보고 싶을 때는 pod 명령 뒤에 pod name을 지정한다.</p><pre><code>```
cychong@mini1:~$ sudo microk8s.kubectl get pod kubernetes-dashboard-6fd7f9c494-48dnz --namespace=kube-system
NAME                                    READY   STATUS    RESTARTS   AGE
kubernetes-dashboard-6fd7f9c494-48dnz   1/1     Running   0          20m

cychong@mini1:~$ sudo microk8s.kubectl get pod kubernetes-dashboard-6fd7f9c494-48dnz --namespace=kube-system -o wide
NAME                                    READY   STATUS    RESTARTS   AGE   IP         NODE    NOMINATED NODE   READINESS GATES
kubernetes-dashboard-6fd7f9c494-48dnz   1/1     Running   0          19m   10.1.1.6   mini1   &lt;none&gt;           &lt;none&gt; 
</code></pre><h3 id=service-확인>Service 확인</h3><pre><code>cychong@mini1:~$ sudo microk8s.kubectl get services
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.152.183.1   &lt;none&gt;        443/TCP   33m

cychong@mini1:~$ sudo microk8s.kubectl cluster-info
[sudo] password for cychong:
Kubernetes master is running at https://127.0.0.1:16443
Heapster is running at https://127.0.0.1:16443/api/v1/namespaces/kube-system/services/heapster/proxy
KubeDNS is running at https://127.0.0.1:16443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
Grafana is running at https://127.0.0.1:16443/api/v1/namespaces/kube-system/services/monitoring-grafana/proxy
InfluxDB is running at https://127.0.0.1:16443/api/v1/namespaces/kube-system/services/monitoring-influxdb:http/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
</code></pre><h1 id=example>Example.</h1><h2 id=ngnix-container-replicaset을-만들고-service로-expose>Ngnix container replicaset을 만들고 service로 expose</h2><p><a href=https://computingforgeeks.com/deploy-lightweight-kubernetes-with-microk8s-and-snap/>Deploy Lightweight Kubernetes with MicroK8s and Snap - Computing for Geeks</a></p><pre><code># microk8s.kubectl run nginx --replicas 2 --image nginx   
deployment.apps/nginx created   
# microk8s.kubectl get deployments   
NAME    READY   UP-TO-DATE   AVAILABLE   AGE   
nginx   2/2     2            2           39s   
# microk8s.kubectl get pods   
NAME                     READY   STATUS    RESTARTS   AGE   
nginx-7db9fccd9b-7662b   1/1     Running   0          61s   
nginx-7db9fccd9b-87z6d   1/1     Running   0          61s


# microk8s.kubectl expose deployment nginx --port 80 --target-port 80 \    
  --type ClusterIP --selector=run=nginx --name nginx   
service/nginx exposed   
# microk8s.kubectl get services   
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   
kubernetes   ClusterIP   10.152.183.1            443/TCP   27m   
nginx        ClusterIP   10.152.183.54           80/TCP    104s


# microk8s.kubectl delete deployment nginx   
deployment.extensions &quot;nginx&quot; deleted   
# microk8s.kubectl delete service nginx   
service &quot;nginx&quot; deleted
</code></pre><h1 id=setup-ghost>Setup Ghost</h1><h2 id=setup-volume>Setup volume</h2><p>ghost의 DB를 sqlite3를 사용하고 있어 DB 파일이 저장될 위치인 공간을 node에 생성한다.</p><h3 id=volumeyaml>volume.yaml</h3><pre><code>kind: PersistentVolume
apiVersion: v1
metadata:
  name: ghost-pv-volume
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 12Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: &quot;/home/cychong/Dropbox/Apps/ghost/content&quot;

cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl apply -f volume.yaml
[sudo] password for cychong:
persistentvolume/ghost-volume created

cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                               STORAGECLASS        REASON   AGE
ghost-volume                               12Gi       RWO            Retain           Available                                       manual                       17s
pvc-942cf467-7906-11e9-8f0b-00264a162bca   20Gi       RWX            Delete           Bound       container-registry/registry-claim   microk8s-hostpath            28h
</code></pre><p>특정 volume 정보만 확인하려면 <code>get pv</code> 뒤에 volume 이름을 지정한다.</p><pre><code>cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl get pv ghost-volume
NAME           CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
ghost-volume   12Gi       RWO            Retain           Available           manual                  24s
</code></pre><p>특정 volume 삭제하려면 <code>delete pv [volume-name]</code>을 사용한다.</p><pre><code>cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                               STORAGECLASS        REASON   AGE
ghost-pv-volume                            12Gi       RWO            Retain           Available                                       manual                       4s
ghost-volume                               12Gi       RWO            Retain           Available                                       manual                       20m
pvc-942cf467-7906-11e9-8f0b-00264a162bca   20Gi       RWX            Delete           Bound       container-registry/registry-claim   microk8s-hostpath            28h

cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl delete pv ghost-volume
persistentvolume &quot;ghost-volume&quot; deleted

cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                               STORAGECLASS        REASON   AGE
ghost-pv-volume                            12Gi       RWO            Retain           Available                                       manual                       112s
pvc-942cf467-7906-11e9-8f0b-00264a162bca   20Gi       RWX            Delete           Bound       container-registry/registry-claim   microk8s-hostpath            28h
</code></pre><h2 id=volume-claim>Volume Claim</h2><p>volume-claim.yaml</p><p>Pod에서 PV를 사용하려면 PVC(Persistent Volume Claim)을 설정한다. 앞에서 본 <code>volume.yaml</code>과 유사하지만 <code>requests</code>를 통해 일정 크기(아래는 10G)를 요청한다.</p><pre><code>kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: ghost-pv-claim
  labels:
    type: local
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi

cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl apply -f volume-claim.yaml
persistentvolumeclaim/ghost-pv-claim created
</code></pre><h3 id=claim-된-volume의-상태-확인>Claim 된 Volume의 상태 확인</h3><p><code>get pv</code> 명령으로 volume의 상태를 확인하면 이전에는 <code>STATUS</code>가 <code>Available</code>이었던 것이 <code>Bound</code>로 변경된 것을 알 수 있다.</p><pre><code>cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl get pv ghost-pv-volume
NAME              CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                    STORAGECLASS   REASON   AGE
ghost-pv-volume   12Gi       RWO            Retain           Bound    default/ghost-pv-claim   manual                  3m40s
</code></pre><p><code>get pvc</code> 명령으로 확인하면 claim된 volume에 대한 정보를 확인할 수 있다.</p><pre><code>cychong@mini1:~$ sudo microk8s.kubectl get pvc
NAME             STATUS   VOLUME            CAPACITY   ACCESS MODES   STORAGECLASS   AGE
ghost-pv-claim   Bound    ghost-pv-volume   12Gi       RWO            manual         146m
</code></pre><h2 id=deploy>Deploy</h2><p>이제 실제 container를 이용한 Pod를 구성한다.</p><p>Pod를 직접 생성하고 Container를 실행할 수도 있지만, 이 경우 Pod의 상태를 확인하여 다시 실행해 주는 kubernetes의 관리 기능을 이용할 수 없다.</p><h3 id=deploymentyaml>deployment.yaml</h3><p>동시에 하나의 ghost container만 띄우면 되므로 아래와 같이 <code>replicas</code>를 1로 지정한다.</p><p>그 외 deploy할 때 항상 최신 docker image를 다운 받도록 <code>imagePullPolicy</code>를 <code>Always</code> 로 설정한다.</p><p>Container에 넘길 환경 변수 등은 <code>env</code> 항목을 통해 넘길 수 있고, 위에서 생성한 volume cliam을 ghost-content라는 이름으로 지정한 후 <code>mountPath</code>를 이용하여 container의 특정 위치에 마운트되도록 한다.</p><p>즉 <code>ghost-pv-volume</code> → <code>ghost-pv-claim</code> → <code>ghost-content</code>→ <code>ghost</code></p><pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: ghost
  labels:
    app: ghost
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ghost
  template:
    metadata:
      labels:
        app: ghost
    spec:
      containers:
      - name: ghost
        image: ghost
        imagePullPolicy: Always
        ports:
        - containerPort: 2368
        env:
        - name: url
          value: http://sosa0sa.com:2368
        - name: NODE_ENV
          value: production
        volumeMounts:
        - mountPath: /var/lib/ghost/content
          name: ghost-content
      volumes:
      - name: ghost-content
        persistentVolumeClaim:
          claimName: ghost-pv-claim

cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl apply -f deployment.yaml
[sudo] password for cychong:
deployment.apps/ghost created

cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl get pods
NAME                     READY   STATUS              RESTARTS   AGE
ghost-79b8c8979d-7m7fm   0/1     ContainerCreating   0          9s

cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl get deploy
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
ghost   0/1     1            0           71s
</code></pre><p>시간이 지나면 READY 상태가 <code>1/1</code>로 변경되고, <code>AVAILABLE</code> 값이 역시 0에서 1로 변경된다.</p><pre><code>cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl get pods
NAME                     READY   STATUS    RESTARTS   AGE
ghost-79b8c8979d-7m7fm   1/1     Running   0          90s
cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl get deploy
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
ghost   1/1     1            1           92s
</code></pre><p>이제 Pod/container는 정상적으로 실행이 된 상태</p><p>만일 <code>ghost</code>라고 명명된 Pod이 비정상 상태가 되면 자동으로 다른 Pod를 실행시킨다.</p><pre><code>cychong@mini1:~/work/ghost-in-k8s$ sudo microk8s.kubectl get pods
NAME                                    READY   STATUS        RESTARTS   AGE
default-http-backend-5769f6bc66-jpcfj   1/1     Terminating   0          27h
ghost-79b8c8979d-7m7fm                  1/1     Running       0          29h

cychong@mini1:~/work/ghost-in-k8s$ sudo microk8s.kubectl delete pod ghost-79b8c8979d-7m7fm
pod &quot;ghost-79b8c8979d-7m7fm&quot; deleted

^Z
[1]+  Stopped                 sudo microk8s.kubectl delete pod ghost-79b8c8979d-7m7fm
cychong@mini1:~/work/ghost-in-k8s$ bg
[1]+ sudo microk8s.kubectl delete pod ghost-79b8c8979d-7m7fm &amp;

cychong@mini1:~/work/ghost-in-k8s$ sudo microk8s.kubectl get pod
NAME                                    READY   STATUS        RESTARTS   AGE
default-http-backend-5769f6bc66-jpcfj   1/1     Terminating   0          27h
ghost-79b8c8979d-468d2                  1/1     Running       0          76s
ghost-79b8c8979d-7m7fm                  1/1     Terminating   0          29h
</code></pre><p>위 예에서는 기존에 동작하고 있던 pod을 삭제하니(정상적으로 삭제가 되지 않아 <code>STATUS</code>가 <code>Terminating</code> 상태로 표시되고 있다. 확인 필요)</p><p><code>kind: Pod</code> or <code>kind: deployment</code>?</p><p>Pod를 직접 생성하는 yaml 파일을 만들어 사용할 수도 있지만 상용에서는 직접 pod를 만들기 보다 deployment를 통해 pod를 생성하고 pod를 관리한다.</p><p><a href=https://stackoverflow.com/questions/41325087/in-kubernetes-what-is-the-difference-between-a-pod-and-a-deployment>In kubernetes what is the difference between a pod and a deployment?</a></p><h2 id=service>Service</h2><p>ghost는 Cluster 외부에서 접속이 필요한 블로그 서비스이므로 외부에서 접속이 가능하도록 external IP를 가질 수 있게 service를 구성한다.</p><h3 id=serviceyaml>service.yaml</h3><pre><code>apiVersion: v1
kind: Service
metadata:
  name: ghost
spec:
  type: LoadBalancer
  selector:
    app: ghost
  ports:
  - protocol: TCP
    port: 2368
    targetPort: 2368
</code></pre><p><code>type:LoadBalancer</code>를 적용하면 외부 통신에 대해 Load Balancer를 사용하여 자동으로 EXTERNAL-IP가 설정된다고 한다.</p><p><a href=https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types>https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types</a></p><blockquote><p>LoadBalancer: Exposes the service externally using a cloud provider’s load balancer. NodePort and ClusterIP services, to which the external load balancer will route, are automatically created.</p></blockquote><p><a href=https://stackoverflow.com/questions/49869989/how-to-install-kubernetes-dashboard-on-external-ip-address>How to install Kubernetes dashboard on external IP address?</a></p><p>하지만 위 파일을 적용했는데 <code>EXTERNAL-IP</code> 정보가 pending으로 나온다.</p><pre><code>cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl apply -f service.yaml
service/ghost created
cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl get service
NAME         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
ghost        LoadBalancer   10.152.183.119   &lt;pending&gt;     2368:30126/TCP   3s
kubernetes   ClusterIP      10.152.183.1     &lt;none&gt;        443/TCP          32h
</code></pre><p>웹 브라우저를 이용해서 Cluster 외부에서 접속(ghost Pod가 deploy된 mini1 머신의 IP로 접속)을 시도해 보지만 접속이 안된다.</p><p>아무래도 저 <code>pending</code> 상태로 나오는 게 이상한데 혹시나 하고 검색을 해 보니 역시나 저렇게 되면 외부에서 접속이 안된다고. 그 이유로 처음에 사용한 service 파일에서 사용된 <code>LoadBalancer</code> type이 microk8s에서는 지원되지 않기 때문이라고 한다. 추가로 load balancer를 설치해도 여전히 안된다고&mldr;</p><blockquote><p>ktsakalozos commented on Nov 23, 2018
Hi @khteh ,
Kubernetes does not provide a loadbalancer. It is assumed that loadbalancers are an external component [1]. MicroK8s is not shipping any loadbalancer but even if it did there would not have been any nodes to balance load over. There is only one node so if you want to expose a service you should use the NodePort service type.</p></blockquote><h3 id=microk8s-does-not-support-loadbalancer>microk8s does not support <code>LoadBalancer</code></h3><p><a href=https://github.com/ubuntu/microk8s/issues/200>nginx loadbalancer service EXTERNAL-IP is always in &ldquo;pending&rdquo; state · Issue #200 · ubuntu/microk8s</a></p><p><a href=https://stackoverflow.com/questions/44110876/kubernetes-service-external-ip-pending>kubernetes service external ip pending</a></p><h3 id=publishing-service-type-변경>Publishing Service Type 변경</h3><p>service.yaml 파일의 Publishing Service Type을 microk8s에서 지원되는 <code>NodePort</code>로 변경한 후 다시 appy한 후 다시 접속을 시도하지만 여전히 접속이 되지 않는다.</p><h3 id=service-수정해서-external-ip-강제-지정>Service 수정해서 External IP 강제 지정</h3><p>Node의 <code>EXTERNAL-IP</code> 정보가 여전히 빈칸으로 나온다.</p><pre><code>cychong@mini1:~/Dropbox/working/kubernetes$ sudo microk8s.kubectl get nodes -o wide
NAME    STATUS   ROLES    AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
mini1   Ready    &lt;none&gt;   35h   v1.14.1   192.168.1.100   &lt;none&gt;        Ubuntu 18.04.2 LTS   4.15.0-48-generic   containerd://1.2.5
</code></pre><p>원래(?) service 에서 NodePort 타입으로 지정하고 port 만 지정하면 Cluster 외부에서 접속이 되어야 하는데 이것 때문에 안되는 듯 하다.</p><p>그래서 결국 임시로 service.yaml 수정해서 external IP를 강제로 지정했다. <code>exteranlIPs</code>이므로 배열 형태로 지정 한다.</p><pre><code>apiVersion: v1
kind: Service
metadata:
  name: ghost
spec:
  type: NodePort
  externalTrafficPolicy : Local
  externalIPs : [192.168.1.100]
  selector:
    app: ghost
  ports:
  - protocol: TCP
    port: 2368
    targetPort: 2368
</code></pre><p>변경된 service.yaml을 적용한 후 service 내용을 확인하면 <code>EXTERNAL-IP</code> 정보가 변경된 것을 확인할 수 있다.</p><pre><code>cychong@mini1:~/work/ghost-in-k8s$ sudo microk8s.kubectl get svc -o wide
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP     PORT(S)          AGE     SELECTOR
ghost        NodePort    10.152.183.119   192.168.1.100   2368:30126/TCP   4h54m   app=ghost
kubernetes   ClusterIP   10.152.183.1     &lt;none&gt;          443/TCP          37h     &lt;none&gt;
</code></pre><p>이제 Cluster 외부에서도 node의 EXTERNAL-IP를 이용해서 접속할 수 있다.</p><h3 id=metallb를-사용하는-것이-대안일까>metalLB를 사용하는 것이 대안일까?</h3><p>ingress 서비스를 enable하고, ngnix를 추가로 설치한다.</p><p><a href=https://kndrck.co/posts/microk8s_ingress_example/>https://kndrck.co/posts/microk8s_ingress_example/</a></p><h2 id=github>github</h2><p>위에서 사용된 모든 YAML 파일은 아래 위치에서 확인할 수 있다.</p><p><a href=https://github.com/cychong47/ghost-in-k8s>cychong47/ghost-in-k8s</a></p><hr><ul class=pager><li class=previous><a href=/post/2019/ghost-deployment-season-4/ data-toggle=tooltip data-placement=top title="ghost deployment season 4">&larr;
Previous Post</a></li><li class=next><a href=/post/2019/boundary-clock/ data-toggle=tooltip data-placement=top title="Boundary Clock">Next
Post &rarr;</a></li></ul><div id=disqus-comment></div></div><div class="col-lg-11 col-lg-offset-1
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/agile title=agile>agile</a>
<a href=/tags/amazon title=amazon>amazon</a>
<a href=/tags/amdocs title=amdocs>amdocs</a>
<a href=/tags/ansible title=ansible>ansible</a>
<a href=/tags/ansible-playbook title=ansible-playbook>ansible-playbook</a>
<a href=/tags/anti-work-pattern title=anti-work-pattern>anti-work-pattern</a>
<a href=/tags/apple title=apple>apple</a>
<a href=/tags/automation title=automation>automation</a>
<a href=/tags/backup title=backup>backup</a>
<a href=/tags/book title=book>book</a>
<a href=/tags/brew title=brew>brew</a>
<a href=/tags/calico title=calico>calico</a>
<a href=/tags/cisco title=cisco>cisco</a>
<a href=/tags/cni title=cni>cni</a>
<a href=/tags/coding-style title=coding-style>coding-style</a>
<a href=/tags/container title=container>container</a>
<a href=/tags/cron title=cron>cron</a>
<a href=/tags/cronjob title=cronjob>cronjob</a>
<a href=/tags/cuda title=cuda>cuda</a>
<a href=/tags/culture title=culture>culture</a>
<a href=/tags/dev-culture title=dev-culture>dev-culture</a>
<a href=/tags/docker title=docker>docker</a>
<a href=/tags/docker-compose title=docker-compose>docker-compose</a>
<a href=/tags/dpdk title=dpdk>dpdk</a>
<a href=/tags/elk title=elk>elk</a>
<a href=/tags/english title=english>english</a>
<a href=/tags/getting-started title=getting-started>getting-started</a>
<a href=/tags/ghost title=ghost>ghost</a>
<a href=/tags/git title=git>git</a>
<a href=/tags/github title=github>github</a>
<a href=/tags/golang title=golang>golang</a>
<a href=/tags/google title=google>google</a>
<a href=/tags/gpu title=gpu>gpu</a>
<a href=/tags/grafana title=grafana>grafana</a>
<a href=/tags/helm title=helm>helm</a>
<a href=/tags/homebrew title=homebrew>homebrew</a>
<a href=/tags/http title=http>http</a>
<a href=/tags/hugo title=hugo>hugo</a>
<a href=/tags/influxdb title=influxdb>influxdb</a>
<a href=/tags/intel title=intel>intel</a>
<a href=/tags/ipad title=ipad>ipad</a>
<a href=/tags/iphone title=iphone>iphone</a>
<a href=/tags/ipsec title=ipsec>ipsec</a>
<a href=/tags/json title=json>json</a>
<a href=/tags/kubernetes title=kubernetes>kubernetes</a>
<a href=/tags/life title=life>life</a>
<a href=/tags/lifehack title=lifehack>lifehack</a>
<a href=/tags/mac-mini-2009 title=mac-mini-2009>mac-mini-2009</a>
<a href=/tags/manager title=manager>manager</a>
<a href=/tags/monitoring title=monitoring>monitoring</a>
<a href=/tags/mysql title=mysql>mysql</a>
<a href=/tags/nfv title=nfv>nfv</a>
<a href=/tags/nginx title=nginx>nginx</a>
<a href=/tags/note title=note>note</a>
<a href=/tags/odp title=odp>odp</a>
<a href=/tags/onap title=onap>onap</a>
<a href=/tags/onp title=onp>onp</a>
<a href=/tags/openstack title=openstack>openstack</a>
<a href=/tags/opnfv title=opnfv>opnfv</a>
<a href=/tags/osx title=osx>osx</a>
<a href=/tags/ovdk title=ovdk>ovdk</a>
<a href=/tags/ovs title=ovs>ovs</a>
<a href=/tags/photo title=photo>photo</a>
<a href=/tags/podcast title=podcast>podcast</a>
<a href=/tags/programming title=programming>programming</a>
<a href=/tags/protocol-buffer title=protocol-buffer>protocol-buffer</a>
<a href=/tags/python title=python>python</a>
<a href=/tags/scapy title=scapy>scapy</a>
<a href=/tags/sdn title=sdn>sdn</a>
<a href=/tags/slack title=slack>slack</a>
<a href=/tags/sw-%EA%B0%9C%EB%B0%9C-%EB%AC%B8%ED%99%94 title=sw-개발-문화>sw-개발-문화</a>
<a href=/tags/team title=team>team</a>
<a href=/tags/telemetry title=telemetry>telemetry</a>
<a href=/tags/til title=til>til</a>
<a href=/tags/troubleshooting title=troubleshooting>troubleshooting</a>
<a href=/tags/ubuntu title=ubuntu>ubuntu</a>
<a href=/tags/vagrant title=vagrant>vagrant</a>
<a href=/tags/virtualization title=virtualization>virtualization</a>
<a href=/tags/vmware title=vmware>vmware</a>
<a href=/tags/vnf title=vnf>vnf</a>
<a href=/tags/vran title=vran>vran</a>
<a href=/tags/wordpress title=wordpress>wordpress</a>
<a href=/tags/%EA%B3%B5%EB%B6%80 title=공부>공부</a>
<a href=/tags/%EA%B4%80%EB%A6%AC%EB%8A%A5%EB%A0%A5 title=관리능력>관리능력</a>
<a href=/tags/%EA%B8%B0%EB%A1%9D title=기록>기록</a>
<a href=/tags/%EB%A6%AC%EB%8D%94 title=리더>리더</a>
<a href=/tags/%EB%AC%B8%ED%99%94 title=문화>문화</a>
<a href=/tags/%EC%83%9D%EC%82%B0%EC%84%B1 title=생산성>생산성</a>
<a href=/tags/%EC%9E%A1%EC%83%9D%EA%B0%81 title=잡생각>잡생각</a>
<a href=/tags/%EC%A1%B0%EC%A7%81%EA%B4%80%EB%A6%AC title=조직관리>조직관리</a>
<a href=/tags/%ED%9A%8C%EC%9D%98 title=회의>회의</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href rel=alternate type=application/rss+xml title="Keep calm and write something"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a href=mailto:cychong@gmail.com><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Keep calm and write something 2021<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function async(u,c){var d=document,t='script',o=d.createElement(t),s=d.getElementsByTagName(t)[0];o.src=u;if(c){o.addEventListener('load',function(e){c(null,e);},false);}
s.parentNode.insertBefore(o,s);}</script><script>if($('#tag_cloud').length!==0){async("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:'#bbbbee',end:'#0085a1'},};$('#tag_cloud a').tagcloud();})}</script><script>async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js",function(){var $nav=document.querySelector("nav");if($nav)FastClick.attach($nav);})</script></body></html>