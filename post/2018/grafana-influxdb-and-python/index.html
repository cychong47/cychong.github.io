<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Keep calm and write something"><meta property="og:type" content="article"><meta property="og:image" content="https://cychong47.github.io/images/another_blog_bg.jpg"><meta property="twitter:image" content="https://cychong47.github.io/images/another_blog_bg.jpg"><meta name=title content="Grafana, influxDB and python"><meta property="og:title" content="Grafana, influxDB and python"><meta property="twitter:title" content="Grafana, influxDB and python"><meta name=description content><meta property="og:description" content><meta property="twitter:description" content><meta property="twitter:card" content="summary"><meta name=keyword content="Blog, cychong, Kubernetes, dpdk"><link rel="shortcut icon" href=/img/favicon.ico><title>Grafana, influxDB and python-another blog</title><link rel=canonical href=/post/2018/grafana-influxdb-and-python/><link rel=stylesheet href=/css/iDisqus.min.css><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hux-blog.min.css><link rel=stylesheet href=/css/zanshang.css><link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://cychong47.github.io/css/custom-cleanwhite.css><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/hux-blog.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=/>Keep calm and write something</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>Home</a></li><li><a href=/categories/book>book</a></li><li><a href=/categories/gadget>gadget</a></li><li><a href=/categories/homelab>homelab</a></li><li><a href=/categories/hugo>hugo</a></li><li><a href=/categories/kubernetes>kubernetes</a></li><li><a href=/categories/life>life</a></li><li><a href=/categories/note>note</a></li><li><a href=/categories/tech>tech</a></li><li><a href=/categories/til>til</a></li><li><a href=/search>SEARCH <img src=/img/search.png height=15 style=cursor:pointer alt=Search></a></li></ul></div></div></div></nav><script>var $body=document.body;var $toggle=document.querySelector('.navbar-toggle');var $navbar=document.querySelector('#huxblog_navbar');var $collapse=document.querySelector('.navbar-collapse');$toggle.addEventListener('click',handleMagic)
function handleMagic(e){if($navbar.className.indexOf('in')>0){$navbar.className=" ";setTimeout(function(){if($navbar.className.indexOf('in')<0){$collapse.style.height="0px"}},400)}else{$collapse.style.height="auto"
$navbar.className+=" in";}}</script><style type=text/css>header.intro-header{background-image:url(/images/another_blog_bg.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/python title=Python>Python</a>
<a class=tag href=/tags/docker title=docker>docker</a>
<a class=tag href=/tags/elk title=elk>elk</a>
<a class=tag href=/tags/til title=til>til</a>
<a class=tag href=/tags/monitoring title=monitoring>monitoring</a>
<a class=tag href=/tags/grafana title=grafana>grafana</a>
<a class=tag href=/tags/influxdb title=influxdb>influxdb</a></div><h1>Grafana, influxDB and python</h1><h2 class=subheading></h2><span class=meta>Posted by
Chaeyong Chong
on
Wednesday, June 6, 2018<br>Last Modified on Sunday, September 9, 2018</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-11 col-lg-offset-1
col-md-10 col-md-offset-1
post-container"><header><h2>TOC</h2></header><nav id=TableOfContents><ul><li><a href=#install-grafana-and-influxdb>Install Grafana and influxDB</a><ul><li><a href=#install-grafana>Install Grafana</a></li><li><a href=#install-influxdb>Install influxDB</a></li><li><a href=#install-influxdb-module-for-python>Install influxdb module for python</a></li><li><a href=#start-influxdb>Start influxdb</a></li><li><a href=#주기적으로-데이터를-influxdb에-저장>주기적으로 데이터를 influxdb에 저장</a></li><li><a href=#influxdb에서-데이터-확인>Influxdb에서 데이터 확인</a></li></ul></li><li><a href=#grafana에서-influxdb에-저장된-정보-읽어오기>Grafana에서 influxdb에 저장된 정보 읽어오기</a><ul><li><a href=#everything-is-working-finally>Everything is working finally</a></li><li><a href=#tips-for-customizing-grafana-dashboard>Tips for customizing grafana dashboard</a></li></ul></li></ul></nav><p>Time-series data를 python을 이용해서 influxDB에 저장하고, Grafana로 그래프를 보여주는 예제</p><p><a href=https://github.com/cychong47/influxdb_example.git>https://github.com/cychong47/influxdb_example.git</a></p><h1 id=install-grafana-and-influxdb>Install Grafana and influxDB</h1><h2 id=install-grafana>Install Grafana</h2><p>직접 호스트에 설치할 수도 있지만, 세상 편하게 만들어준 docker를 이용해서 grafana, influxdb등을 설치하자.</p><pre><code>mbpr15:~ cychong$ docker pull grafana/grafana 
Using default tag: latest
latest: Pulling from grafana/grafana
f2aa67a397c4: Pull complete 
89573effc7c8: Pull complete 
b55c103da375: Pull complete 
Digest: sha256:364bec4a39ecbec744ea4270aae35f6554eb6f2047b3ee08f7b5f1134857c32c
Status: Downloaded newer image for grafana/grafana:latest
</code></pre><p>Start <code>grafana</code></p><pre><code>mbpr15:~ cychong$ docker run -d -p 3000:3000 —name grafana grafana/grafana 
148894d7009259b02b04e1a98467f549400be91f9b055f8686557d69b9339e4b
</code></pre><h2 id=install-influxdb>Install influxDB</h2><p>influxdb도 docker 명령어 하나로 설치</p><p><a href=https://docs.docker.com/samples/library/influxdb/>influxdb | Docker Documentation</a></p><pre><code>mbpr15:~ cychong$ docker pull influxdb
Using default tag: latest
latest: Pulling from library/influxdb
cc1a78bfd46b: Pull complete 
6861473222a6: Pull complete 
7e0b9c3b5ae0: Pull complete 
ef1cd6af9147: Pull complete 
07d71592a7b6: Pull complete 
4df1ab172fbc: Pull complete 
6f607c73c187: Pull complete 
3fd297f39292: Pull complete 
Digest: sha256:e3efb51395d630a912c3c24edb7567ec1ac01d3dfdc39f27f53ca0e15c3da797
Status: Downloaded newer image for influxdb:latest
</code></pre><h2 id=install-influxdb-module-for-python>Install influxdb module for python</h2><p>python에서 직접 influxDB를 사용하려면 <code>influxdb</code> 모듈을 사용한다</p><pre><code>mbpr15:~ cychong$ pip3 install influxdb
Collecting influxdb
  Downloading https://files.pythonhosted.org/packages/8d/79/7972c12e393080eda6920583c9c2ed2206771da7f6341c8971a2c02ff3d3/influxdb-5.0.0-py2.py3-none-any.whl (70kB)
    100% |████████████████████████████████| 71kB 709kB/s 
Requirement already satisfied: requests&gt;=2.17.0 in /usr/local/lib/python3.6/site-packages (from influxdb) (2.18.4)
Collecting python-dateutil&gt;=2.6.0 (from influxdb)
  Downloading https://files.pythonhosted.org/packages/cf/f5/af2b09c957ace60dcfac112b669c45c8c97e32f94aa8b56da4c6d1682825/python_dateutil-2.7.3-py2.py3-none-any.whl (211kB)
    100% |████████████████████████████████| 215kB 2.9MB/s 
Collecting pytz (from influxdb)
  Downloading https://files.pythonhosted.org/packages/dc/83/15f7833b70d3e067ca91467ca245bae0f6fe56ddc7451aa0dc5606b120f2/pytz-2018.4-py2.py3-none-any.whl (510kB)
    100% |████████████████████████████████| 512kB 5.0MB/s 
Requirement already satisfied: six&gt;=1.10.0 in /usr/local/lib/python3.6/site-packages (from influxdb) (1.11.0)
Requirement already satisfied: certifi&gt;=2017.4.17 in /usr/local/lib/python3.6/site-packages (from requests&gt;=2.17.0-&gt;influxdb) (2017.11.5)
Requirement already satisfied: idna&lt;2.7,&gt;=2.5 in /usr/local/lib/python3.6/site-packages (from requests&gt;=2.17.0-&gt;influxdb) (2.6)
Requirement already satisfied: chardet&lt;3.1.0,&gt;=3.0.2 in /usr/local/lib/python3.6/site-packages (from requests&gt;=2.17.0-&gt;influxdb) (3.0.4)
Requirement already satisfied: urllib3&lt;1.23,&gt;=1.21.1 in /usr/local/lib/python3.6/site-packages (from requests&gt;=2.17.0-&gt;influxdb) (1.22)
hacking 1.0.0 has requirement flake8&lt;2.6.0,&gt;=2.5.4, but you’ll have flake8 3.5.0 which is incompatible.
hacking 1.0.0 has requirement mccabe==0.2.1, but you’ll have mccabe 0.6.1 which is incompatible.
hacking 1.0.0 has requirement pyflakes==0.8.1, but you’ll have pyflakes 1.6.0 which is incompatible.
docker-compose 1.17.1 has requirement requests!=2.11.0,&lt;2.12,&gt;=2.6.1, but you’ll have requests 2.18.4 which is incompatible.
Installing collected packages: python-dateutil, pytz, influxdb
Successfully installed influxdb-5.0.0 python-dateutil-2.7.3 pytz-2018.4
</code></pre><h2 id=start-influxdb>Start influxdb</h2><p><a href=https://www.influxdata.com/blog/getting-started-python-influxdb/>Getting Started with Python and Influxdb | InfluxData</a></p><pre><code>mbpr15:working cychong$ mkdir influxdb
mbpr15:working cychong$ cd influxdb/
mbpr15:influxdb cychong$ ls
mbpr15:influxdb cychong$ docker run -d -p 8086:8086 -v $PWD:/var/lib/influxdb influxdb
5088889ce21c9c9e2249db701694aa0bd39429371b5dababcf6ebb8c2e7598d3
</code></pre><p>To have customized config file for influxdb.
First generate the default configuration file and update it. Then restart influxdb with that config file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mbpr15:influxdb cychong$ docker run —rm influxdb influxd config &gt; influxdb.conf
Merging with configuration at: /etc/influxdb/influxdb.conf

mbpr15:influxdb cychong$ docker run -d -p 8086:8086 -v <span style=color:#8be9fd;font-style:italic>$PWD</span>:/var/lib/influxdb -v <span style=color:#8be9fd;font-style:italic>$PWD</span>/influxdb.conf:/etc/influxdb/influxdb.conf influxdb -config /etc/influxdb/influxdb.conf
1d9ac4ffdca38b2c627da134273d7570c9c74182cb4bbedb8deebf09c3e5dc0a
</code></pre></div><h3 id=influx-db-write-error>Influx db write error</h3><p><a href=https://github.com/influxdata/influxdb-python/blob/master/examples/tutorial.py>influxdb-python/tutorial.py at master · influxdata/influxdb-python · GitHub</a> 샘플코드를 그대로 실행시키면 다음과 같은 에러를 만난다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mbpr15:influxdb cychong$ python3 influxdb-ex.py 
Create database: example
Create a retention policy
Switch user: smly
Write points: <span style=color:#ff79c6>[{</span><span style=color:#f1fa8c>&#39;measurement&#39;</span>: <span style=color:#f1fa8c>&#39;cpu_load_short&#39;</span>, <span style=color:#f1fa8c>&#39;tags&#39;</span>: <span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#39;host&#39;</span>: <span style=color:#f1fa8c>&#39;server01&#39;</span>, <span style=color:#f1fa8c>&#39;region&#39;</span>: <span style=color:#f1fa8c>&#39;us-west&#39;</span><span style=color:#ff79c6>}</span>, <span style=color:#f1fa8c>&#39;time&#39;</span>: <span style=color:#f1fa8c>&#39;2009-11-10T23:00:00Z&#39;</span>, <span style=color:#f1fa8c>&#39;fields&#39;</span>: <span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#39;Float_value&#39;</span>: 0.64, <span style=color:#f1fa8c>&#39;Int_value&#39;</span>: 3, <span style=color:#f1fa8c>&#39;String_value&#39;</span>: <span style=color:#f1fa8c>&#39;Text&#39;</span>, <span style=color:#f1fa8c>&#39;Bool_value&#39;</span>: True<span style=color:#ff79c6>}}]</span>
Traceback <span style=color:#ff79c6>(</span>most recent call last<span style=color:#ff79c6>)</span>:
  File <span style=color:#f1fa8c>&#34;influxdb-ex.py&#34;</span>, line 73, in &lt;module&gt;
    main<span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>host</span><span style=color:#ff79c6>=</span>args.host, <span style=color:#8be9fd;font-style:italic>port</span><span style=color:#ff79c6>=</span>args.port<span style=color:#ff79c6>)</span>
  File <span style=color:#f1fa8c>&#34;influxdb-ex.py&#34;</span>, line 45, in main
    client.write_points<span style=color:#ff79c6>(</span>json_body<span style=color:#ff79c6>)</span>
  File <span style=color:#f1fa8c>&#34;/usr/local/lib/python3.6/site-packages/influxdb/client.py&#34;</span>, line 468, in write_points
    <span style=color:#8be9fd;font-style:italic>tags</span><span style=color:#ff79c6>=</span>tags, <span style=color:#8be9fd;font-style:italic>protocol</span><span style=color:#ff79c6>=</span>protocol<span style=color:#ff79c6>)</span>
  File <span style=color:#f1fa8c>&#34;/usr/local/lib/python3.6/site-packages/influxdb/client.py&#34;</span>, line 532, in _write_points
    <span style=color:#8be9fd;font-style:italic>protocol</span><span style=color:#ff79c6>=</span>protocol
  File <span style=color:#f1fa8c>&#34;/usr/local/lib/python3.6/site-packages/influxdb/client.py&#34;</span>, line 312, in write
    <span style=color:#8be9fd;font-style:italic>headers</span><span style=color:#ff79c6>=</span>headers
  File <span style=color:#f1fa8c>&#34;/usr/local/lib/python3.6/site-packages/influxdb/client.py&#34;</span>, line 271, in request
    raise InfluxDBClientError<span style=color:#ff79c6>(</span>response.content, response.status_code<span style=color:#ff79c6>)</span>
influxdb.exceptions.InfluxDBClientError: 400: <span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;error&#34;</span>:<span style=color:#f1fa8c>&#34;partial write: points beyond retention policy dropped=1&#34;</span><span style=color:#ff79c6>}</span>
</code></pre></div><p>무슨 말인가 찾아보니 <code>retention policy</code>라는 건 db에 저장하는 데이터가 특정 기준이상으로 오래된 것이면 저장을 불허하기 때문에 이 <code>policy</code>에 걸려 write 동작이 실패했다는 것이다.
<a href=https://github.com/influxdata/influxdb/issues/9093>points beyond retention policy !! what does this mean?? · Issue #9093 · influxdata/influxdb · GitHub</a></p><p>참고로 예제에서는 retention policy를 3일로 지정하고 있는데 샘플용 json 데이터에 지정된 시각이 <code>2009-11-10T23:00:00Z</code>라 에러가 발생한 것.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    <span style=color:#ff79c6>print</span>(<span style=color:#f1fa8c>&#34;Create a retention policy&#34;</span>)

    client<span style=color:#ff79c6>.</span>create_retention_policy(<span style=color:#f1fa8c>&#39;awesome_policy&#39;</span>, <span style=color:#f1fa8c>&#39;3d&#39;</span>, <span style=color:#bd93f9>3</span>, default<span style=color:#ff79c6>=</span>True)
</code></pre></div><p>샘플에서 time 필드를 현재 시간으로 변경한다. 이때 influxdb가 원하는 시간 형태로 표시해야 한다. <a href=https://stackoverflow.com/questions/32090883/how-to-use-time-field-in-adding-metrics-data-to-the-influx-db>python - How to use time field in adding metrics data to the influx db? - Stack Overflow</a>을 참고하여 수정.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#ff79c6>from</span> datetime <span style=color:#ff79c6>import</span> datetime
current_time <span style=color:#ff79c6>=</span> datetime<span style=color:#ff79c6>.</span>utcnow()<span style=color:#ff79c6>.</span>strftime(‘<span style=color:#ff79c6>%</span>Y<span style=color:#ff79c6>-%</span>m<span style=color:#ff79c6>-%</span>dT<span style=color:#ff79c6>%</span>H:<span style=color:#ff79c6>%</span>M:<span style=color:#ff79c6>%</span>SZ’)
</code></pre></div><pre><code>    json_body[0]['time'] = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')
</code></pre><p>수정 후 정상적으로 동작</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mbpr15:influxdb cychong$ python3 influxdb-ex.py 
Create database: example
Create a retention policy
Switch user: smly
Write points: <span style=color:#ff79c6>[{</span>‘measurement’: ‘cpu_load_short’, ‘tags’: <span style=color:#ff79c6>{</span>‘host’: ‘server01’, ‘region’: ‘us-west’<span style=color:#ff79c6>}</span>, ‘time’: ‘2018-06-06T03:08:17Z’, ‘fields’: <span style=color:#ff79c6>{</span>‘Float_value’: 0.64, ‘Int_value’: 3, ‘String_value’: ‘Text’, ‘Bool_value’: True<span style=color:#ff79c6>}}]</span>
Querying data: <span style=color:#ff79c6>select</span> value from cpu_load_short;
Result: ResultSet<span style=color:#ff79c6>({})</span>
Switch user: root
Drop database: example
</code></pre></div><h2 id=주기적으로-데이터를-influxdb에-저장>주기적으로 데이터를 influxdb에 저장</h2><p>이제 주기적으로 데이터를 db에 저장해서 말그래도 time-series data가 되도록 한다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#ff79c6>import</span> argparse
<span style=color:#ff79c6>import</span> time
<span style=color:#ff79c6>import</span> random

<span style=color:#ff79c6>from</span> datetime <span style=color:#ff79c6>import</span> datetime
<span style=color:#ff79c6>from</span> influxdb <span style=color:#ff79c6>import</span> InfluxDBClient

<span style=color:#ff79c6>def</span> <span style=color:#50fa7b>setup_db</span>(host, port):
    user <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;root&#39;</span>
    password <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;root&#39;</span>
    dbname <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;example&#39;</span>
    dbuser <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;smly&#39;</span>
    dbuser_password <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;my_secret_password&#39;</span>

    client <span style=color:#ff79c6>=</span> InfluxDBClient(host, port, user, password, dbname)

    <span style=color:#ff79c6>print</span>(<span style=color:#f1fa8c>&#34;Create database: &#34;</span> <span style=color:#ff79c6>+</span> dbname)
    client<span style=color:#ff79c6>.</span>create_database(dbname)

    <span style=color:#ff79c6>print</span>(<span style=color:#f1fa8c>&#34;Create a retention policy&#34;</span>)
    client<span style=color:#ff79c6>.</span>create_retention_policy(<span style=color:#f1fa8c>&#39;awesome_policy&#39;</span>, <span style=color:#f1fa8c>&#39;3d&#39;</span>, <span style=color:#bd93f9>3</span>, default<span style=color:#ff79c6>=</span>True)

    <span style=color:#ff79c6>print</span>(<span style=color:#f1fa8c>&#34;Switch user: &#34;</span> <span style=color:#ff79c6>+</span> dbuser)
    client<span style=color:#ff79c6>.</span>switch_user(dbuser, dbuser_password)

    <span style=color:#ff79c6>return</span> client

<span style=color:#ff79c6>def</span> <span style=color:#50fa7b>add_data</span>(client, dl_tp, ul_tp):
    json_body <span style=color:#ff79c6>=</span> [
        {
            <span style=color:#f1fa8c>&#34;measurement&#34;</span>: <span style=color:#f1fa8c>&#34;throughput&#34;</span>,
            <span style=color:#f1fa8c>&#34;tags&#34;</span>: {
                <span style=color:#f1fa8c>&#34;host&#34;</span>: <span style=color:#f1fa8c>&#34;server01&#34;</span>,
                <span style=color:#f1fa8c>&#34;region&#34;</span>: <span style=color:#f1fa8c>&#34;us-west&#34;</span>
            },
            <span style=color:#f1fa8c>&#34;time&#34;</span>: <span style=color:#f1fa8c>&#34;2009-11-10T23:00:00Z&#34;</span>,
            <span style=color:#f1fa8c>&#34;fields&#34;</span>: {
                <span style=color:#f1fa8c>&#34;dl_tp&#34;</span> : <span style=color:#bd93f9>0</span>,
                <span style=color:#f1fa8c>&#34;ul_tp&#34;</span> : <span style=color:#bd93f9>0</span>,
            }
        }
    ]

    json_body[<span style=color:#bd93f9>0</span>][<span style=color:#f1fa8c>&#39;time&#39;</span>] <span style=color:#ff79c6>=</span> datetime<span style=color:#ff79c6>.</span>utcnow()<span style=color:#ff79c6>.</span>strftime(<span style=color:#f1fa8c>&#39;%Y-%m-</span><span style=color:#f1fa8c>%d</span><span style=color:#f1fa8c>T%H:%M:%SZ&#39;</span>)
    json_body[<span style=color:#bd93f9>0</span>][<span style=color:#f1fa8c>&#39;fields&#39;</span>][<span style=color:#f1fa8c>&#39;dl_tp&#39;</span>] <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>int</span>(dl_tp)
    json_body[<span style=color:#bd93f9>0</span>][<span style=color:#f1fa8c>&#39;fields&#39;</span>][<span style=color:#f1fa8c>&#39;ul_tp&#39;</span>] <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>int</span>(ul_tp)

    <span style=color:#6272a4>#print(&#34;Write points: {0}&#34;.format(json_body))</span>

    client<span style=color:#ff79c6>.</span>write_points(json_body)

<span style=color:#ff79c6>def</span> <span style=color:#50fa7b>main</span>(host<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;localhost&#39;</span>, port<span style=color:#ff79c6>=</span><span style=color:#bd93f9>8086</span>):
    <span style=color:#f1fa8c>&#34;&#34;&#34;Instantiate a connection to the InfluxDB.&#34;&#34;&#34;</span>

    client <span style=color:#ff79c6>=</span> setup_db(host, port)

    <span style=color:#ff79c6>while</span> True:
        dl_tp <span style=color:#ff79c6>=</span> random<span style=color:#ff79c6>.</span>uniform(<span style=color:#bd93f9>150</span>,<span style=color:#bd93f9>200</span>)
        ul_tp <span style=color:#ff79c6>=</span> random<span style=color:#ff79c6>.</span>uniform(<span style=color:#bd93f9>50</span>,<span style=color:#bd93f9>70</span>)
        add_data(client, dl_tp, ul_tp)
        time<span style=color:#ff79c6>.</span>sleep(<span style=color:#bd93f9>1</span>)

<span style=color:#ff79c6>def</span> <span style=color:#50fa7b>parse_args</span>():
    <span style=color:#f1fa8c>&#34;&#34;&#34;Parse the args.&#34;&#34;&#34;</span>
    parser <span style=color:#ff79c6>=</span> argparse<span style=color:#ff79c6>.</span>ArgumentParser(
        description<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;example code to play with InfluxDB&#39;</span>)
    parser<span style=color:#ff79c6>.</span>add_argument(<span style=color:#f1fa8c>&#39;--host&#39;</span>, <span style=color:#8be9fd;font-style:italic>type</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>str</span>, required<span style=color:#ff79c6>=</span>False,
                        default<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;localhost&#39;</span>,
                        help<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;hostname of InfluxDB http API&#39;</span>)
    parser<span style=color:#ff79c6>.</span>add_argument(<span style=color:#f1fa8c>&#39;--port&#39;</span>, <span style=color:#8be9fd;font-style:italic>type</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>int</span>, required<span style=color:#ff79c6>=</span>False, default<span style=color:#ff79c6>=</span><span style=color:#bd93f9>8086</span>,
                        help<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;port of InfluxDB http API&#39;</span>)
    <span style=color:#ff79c6>return</span> parser<span style=color:#ff79c6>.</span>parse_args()


<span style=color:#ff79c6>if</span> __name__ <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;__main__&#39;</span>:
    args <span style=color:#ff79c6>=</span> parse_args()
    main(host<span style=color:#ff79c6>=</span>args<span style=color:#ff79c6>.</span>host, port<span style=color:#ff79c6>=</span>args<span style=color:#ff79c6>.</span>port)
</code></pre></div><h2 id=influxdb에서-데이터-확인>Influxdb에서 데이터 확인</h2><p>influxdb container에 접속해서 cli 명령을 통해 db 내용을 확인해 본다.</p><pre><code>mbpr15:influxdb cychong$ docker exec -it 1d9ac4ffdca3 influx
Connected to http://localhost:8086 version 1.5.3
InfluxDB shell version: 1.5.3
&gt; use example
Using database example
&gt; show field keys;
name: throughput
fieldKey fieldType
-------- ---------
dl_tp    integer
ul_tp    integer
&gt; select * from throughput;
name: throughput
time                dl_tp host     region  ul_tp
----                ----- ----     ------  -----
1528255918000000000 0     server01 us-west 0
1528255919000000000 0     server01 us-west 0
1528255920000000000 0     server01 us-west 0
1528255921000000000 0     server01 us-west 0
1528255922000000000 0     server01 us-west 0
...
1528256939000000000 199   server01 us-west 50
1528256940000000000 189   server01 us-west 62
1528256941000000000 163   server01 us-west 50
1528256942000000000 152   server01 us-west 52
1528256943000000000 182   server01 us-west 69
1528256944000000000 191   server01 us-west 55
1528256945000000000 190   server01 us-west 61
1528256946000000000 178   server01 us-west 68
&gt; 
</code></pre><h1 id=grafana에서-influxdb에-저장된-정보-읽어오기>Grafana에서 influxdb에 저장된 정보 읽어오기</h1><p>Grafana에서 data source로 influxdb 지정.(URL 필드에 <code>http://localhost:8086</code> 지정)
이상하게도 같은 머신에서 돌고 있는 influxdb의 주소를 <code>localhost</code>로 지정하면 연결이 안된다는 에러가 난다.</p><p><img src=/images/2018/06/grafana-influxd-localhost-nok.png alt=grafana-influxd-localhost-nok></p><p>머신에 할당된 다른 IP를 지정하면 정상적으로 설정(이때는 스타벅스에서 실행했는데 이때 할당된 IP가 172.20.10.3 이었다)
<img src=/images/2018/06/grafana-influxd-ip-ok.png alt=grafana-influxd-ip-ok></p><h2 id=everything-is-working-finally>Everything is working finally</h2><p><img src=/images/2018/06/grafana-influxd-demo1.png alt=grafana-influxd-demo1></p><h2 id=tips-for-customizing-grafana-dashboard>Tips for customizing grafana dashboard</h2><p>Metric 설정할 때는 <code>FROM</code>에서 influxDB의 <code>measurement</code>를 선택하면 아래 <code>SELECT</code>의 필드에 자동으로 선택할 수 있는 <code>fields</code>가 제시된다.</p><p><img src=/images/2018/06/grafana-influxdb-metric.png alt=grafana-influxdb-metric></p><p>influxDB에 정보를 저장할 때 사용한 json과 비교해 보면 <code>fields</code> 에 정의했던 키들이 제시된다.
<img src=/images/2018/06/grafana-influxdb-metric-fields.png alt=grafana-influxdb-metric-fields></p><p><code>GROUP BY</code> 는 데이터 중 특정 종류에 속하는 것만 보여주고 싶을 때 사용할 수 있다. 예를 들어 <code>fields</code>를 <code>dl_tp</code>와 <code>ul_tp</code>로 정의하지 않고, <code>tags</code>에 <code>direction</code>이라는 필드를 두고, <code>fields</code>는 그냥 <code>tp</code>로 정의할 수 있다. 즉 위 예제는 하나의 데이터 셋에 <code>ul_tp</code>와 <code>dl_tp</code>가 모두 있지만, UL <code>tp</code>만을 가진 데이터 셋과 DL <code>tp</code>만을 가진 데이터 셋으로 분리하여 influxdb에 저장할 수 있다. 이 경우 DL <code>tp</code>만을 가진 데이터 셋만으로 metric을 한정하려면 아래 있는 <code>GROUP BY</code>을 사용하여 <code>tag(diretion)</code>을 선택하면 되지 않을까?
<img src=/images/2018/06/grafana-influxdb-tags-groupby.png alt=grafana-influxdb-tags-groupby></p><p>Axes 의 <code>unit</code>을 데이터에 맞는 적절한 것으로 선택하면 데이터의 특성을 강조할 수 있다. 아래는 <code>data rate</code>의 <code>bits/sec</code>를 선택한 경우이다.(데이터 값이 이미 Mbps로 전달된 경우에는 이를 고려하여 <code>megabits/sec</code>를 선택하면 된다)</p><p><img src=/images/2018/06/grafana-influxdb-change-axes-unit.png alt=grafana-influxdb-change-axes-unit></p><hr><ul class=pager><li class=previous><a href=/post/2020/2020-12-27-go-go-ms-for-arm/ data-toggle=tooltip data-placement=top title="An Example Post">&larr;
Previous Post</a></li><li class=next><a href=/post/2018/wordpress-admin-login-fail/ data-toggle=tooltip data-placement=top title="wordpress admin 계정 복구">Next
Post &rarr;</a></li></ul><div id=disqus-comment></div></div><div class="col-lg-11 col-lg-offset-1
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/agile title=agile>agile</a>
<a href=/tags/amazon title=amazon>amazon</a>
<a href=/tags/amdocs title=amdocs>amdocs</a>
<a href=/tags/ansible title=ansible>ansible</a>
<a href=/tags/ansible-playbook title=ansible-playbook>ansible-playbook</a>
<a href=/tags/anti-work-pattern title=anti-work-pattern>anti-work-pattern</a>
<a href=/tags/apple title=apple>apple</a>
<a href=/tags/automation title=automation>automation</a>
<a href=/tags/backup title=backup>backup</a>
<a href=/tags/book title=book>book</a>
<a href=/tags/brew title=brew>brew</a>
<a href=/tags/calico title=calico>calico</a>
<a href=/tags/cisco title=cisco>cisco</a>
<a href=/tags/cni title=cni>cni</a>
<a href=/tags/coding-style title=coding-style>coding-style</a>
<a href=/tags/container title=container>container</a>
<a href=/tags/cron title=cron>cron</a>
<a href=/tags/cronjob title=cronjob>cronjob</a>
<a href=/tags/cuda title=cuda>cuda</a>
<a href=/tags/culture title=culture>culture</a>
<a href=/tags/dev-culture title=dev-culture>dev-culture</a>
<a href=/tags/devonthink title=devonthink>devonthink</a>
<a href=/tags/docker title=docker>docker</a>
<a href=/tags/docker-compose title=docker-compose>docker-compose</a>
<a href=/tags/dpdk title=dpdk>dpdk</a>
<a href=/tags/elk title=elk>elk</a>
<a href=/tags/english title=english>english</a>
<a href=/tags/getting-started title=getting-started>getting-started</a>
<a href=/tags/ghost title=ghost>ghost</a>
<a href=/tags/git title=git>git</a>
<a href=/tags/github title=github>github</a>
<a href=/tags/golang title=golang>golang</a>
<a href=/tags/google title=google>google</a>
<a href=/tags/gpu title=gpu>gpu</a>
<a href=/tags/grafana title=grafana>grafana</a>
<a href=/tags/helm title=helm>helm</a>
<a href=/tags/homebrew title=homebrew>homebrew</a>
<a href=/tags/http title=http>http</a>
<a href=/tags/hugo title=hugo>hugo</a>
<a href=/tags/influxdb title=influxdb>influxdb</a>
<a href=/tags/intel title=intel>intel</a>
<a href=/tags/ipad title=ipad>ipad</a>
<a href=/tags/iphone title=iphone>iphone</a>
<a href=/tags/ipsec title=ipsec>ipsec</a>
<a href=/tags/json title=json>json</a>
<a href=/tags/kubernetes title=kubernetes>kubernetes</a>
<a href=/tags/life title=life>life</a>
<a href=/tags/lifehack title=lifehack>lifehack</a>
<a href=/tags/mac-mini-2009 title=mac-mini-2009>mac-mini-2009</a>
<a href=/tags/manager title=manager>manager</a>
<a href=/tags/monitoring title=monitoring>monitoring</a>
<a href=/tags/mysql title=mysql>mysql</a>
<a href=/tags/nfv title=nfv>nfv</a>
<a href=/tags/nginx title=nginx>nginx</a>
<a href=/tags/note title=note>note</a>
<a href=/tags/odp title=odp>odp</a>
<a href=/tags/onap title=onap>onap</a>
<a href=/tags/onp title=onp>onp</a>
<a href=/tags/openstack title=openstack>openstack</a>
<a href=/tags/opnfv title=opnfv>opnfv</a>
<a href=/tags/osx title=osx>osx</a>
<a href=/tags/ovdk title=ovdk>ovdk</a>
<a href=/tags/ovs title=ovs>ovs</a>
<a href=/tags/photo title=photo>photo</a>
<a href=/tags/podcast title=podcast>podcast</a>
<a href=/tags/programming title=programming>programming</a>
<a href=/tags/protocol-buffer title=protocol-buffer>protocol-buffer</a>
<a href=/tags/python title=python>python</a>
<a href=/tags/scapy title=scapy>scapy</a>
<a href=/tags/sdn title=sdn>sdn</a>
<a href=/tags/slack title=slack>slack</a>
<a href=/tags/sw-%EA%B0%9C%EB%B0%9C-%EB%AC%B8%ED%99%94 title=sw-개발-문화>sw-개발-문화</a>
<a href=/tags/team title=team>team</a>
<a href=/tags/telemetry title=telemetry>telemetry</a>
<a href=/tags/til title=til>til</a>
<a href=/tags/troubleshooting title=troubleshooting>troubleshooting</a>
<a href=/tags/ubuntu title=ubuntu>ubuntu</a>
<a href=/tags/vagrant title=vagrant>vagrant</a>
<a href=/tags/virtualization title=virtualization>virtualization</a>
<a href=/tags/vmware title=vmware>vmware</a>
<a href=/tags/vnf title=vnf>vnf</a>
<a href=/tags/vran title=vran>vran</a>
<a href=/tags/wordpress title=wordpress>wordpress</a>
<a href=/tags/%EA%B3%B5%EB%B6%80 title=공부>공부</a>
<a href=/tags/%EA%B4%80%EB%A6%AC%EB%8A%A5%EB%A0%A5 title=관리능력>관리능력</a>
<a href=/tags/%EA%B8%B0%EB%A1%9D title=기록>기록</a>
<a href=/tags/%EB%A6%AC%EB%8D%94 title=리더>리더</a>
<a href=/tags/%EB%AC%B8%ED%99%94 title=문화>문화</a>
<a href=/tags/%EC%83%9D%EC%82%B0%EC%84%B1 title=생산성>생산성</a>
<a href=/tags/%EC%9E%A1%EC%83%9D%EA%B0%81 title=잡생각>잡생각</a>
<a href=/tags/%EC%A1%B0%EC%A7%81%EA%B4%80%EB%A6%AC title=조직관리>조직관리</a>
<a href=/tags/%ED%9A%8C%EC%9D%98 title=회의>회의</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href rel=alternate type=application/rss+xml title="Keep calm and write something"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a href=mailto:cychong@gmail.com><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Keep calm and write something 2021<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function async(u,c){var d=document,t='script',o=d.createElement(t),s=d.getElementsByTagName(t)[0];o.src=u;if(c){o.addEventListener('load',function(e){c(null,e);},false);}
s.parentNode.insertBefore(o,s);}</script><script>if($('#tag_cloud').length!==0){async("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:'#bbbbee',end:'#0085a1'},};$('#tag_cloud a').tagcloud();})}</script><script>async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js",function(){var $nav=document.querySelector("nav");if($nav)FastClick.attach($nav);})</script></body></html>