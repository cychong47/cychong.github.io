<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Keep calm and write something"><meta property="og:type" content="article"><meta property="og:image" content="https://cychong47.github.io/img/home-bg-jeep.jpg"><meta property="twitter:image" content="https://cychong47.github.io/img/home-bg-jeep.jpg"><meta name=title content="how to build IPsec packet with scapy"><meta property="og:title" content="how to build IPsec packet with scapy"><meta property="twitter:title" content="how to build IPsec packet with scapy"><meta name=description content="Keep calm and write something"><meta property="og:description" content="Keep calm and write something"><meta property="twitter:description" content="Keep calm and write something"><meta property="twitter:card" content="summary"><meta name=keyword content="Blog, cychong, Kubernetes, dpdk"><link rel="shortcut icon" href=/img/favicon.ico><title>how to build IPsec packet with scapy-another blog</title><link rel=canonical href=/post/2016/how-to-use-snapy-for-ipsec/><link rel=stylesheet href=/css/iDisqus.min.css><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hux-blog.min.css><link rel=stylesheet href=/css/zanshang.css><link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css rel=stylesheet type=text/css><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/hux-blog.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=/>Keep calm and write something</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>Home</a></li><li><a href=/categories/book>book</a></li><li><a href=/categories/gadget>gadget</a></li><li><a href=/categories/homelab>homelab</a></li><li><a href=/categories/hugo>hugo</a></li><li><a href=/categories/kubernetes>kubernetes</a></li><li><a href=/categories/life>life</a></li><li><a href=/categories/note>note</a></li><li><a href=/categories/til>til</a></li><li><a href=/search>SEARCH <img src=/img/search.png height=15 style=cursor:pointer alt=Search></a></li></ul></div></div></div></nav><script>var $body=document.body;var $toggle=document.querySelector('.navbar-toggle');var $navbar=document.querySelector('#huxblog_navbar');var $collapse=document.querySelector('.navbar-collapse');$toggle.addEventListener('click',handleMagic)
function handleMagic(e){if($navbar.className.indexOf('in')>0){$navbar.className=" ";setTimeout(function(){if($navbar.className.indexOf('in')<0){$collapse.style.height="0px"}},400)}else{$collapse.style.height="auto"
$navbar.className+=" in";}}</script><style type=text/css>header.intro-header{background-image:url(/img/home-bg-jeep.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/python title=Python>Python</a>
<a class=tag href=/tags/scapy title=scapy>scapy</a>
<a class=tag href=/tags/ipsec title=IPsec>IPsec</a>
<a class=tag href=/tags/%EA%B3%B5%EB%B6%80 title=공부>공부</a></div><h1>how to build IPsec packet with scapy</h1><h2 class=subheading></h2><span class=meta>Posted by
Chaeyong Chong
on
Sunday, February 14, 2016<br>Last Modified on Sunday, April 1, 2018</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-11 col-lg-offset-1
col-md-10 col-md-offset-1
post-container"><header><h2>TOC</h2></header><nav id=TableOfContents><ul><li><ul><li><a href=#import-modules>import modules</a></li><li><a href=#build-plaintext-packet>build plaintext packet</a></li><li><a href=#setup-sa>setup SA</a></li><li><a href=#encrypt-wo-iv>Encrypt w/o IV</a></li><li><a href=#encrypt-w-iv>Encrypt w/ IV</a></li><li><a href=#securityassocaition-옵션>SecurityAssocaition 옵션</a></li></ul></li></ul></nav><h2 id=import-modules>import modules</h2><pre><code>$ python
&gt;&gt;&gt; from scapy.all import *
&gt;&gt;&gt; from scapy.layers.ipsec import *
</code></pre><h2 id=build-plaintext-packet>build plaintext packet</h2><pre><code>&gt;&gt;&gt; p = IP(src='1.1.1.1', dst='2.2.2.2') / TCP(sport=45012, dport=80) / Raw('testdata') 
&gt;&gt;&gt; p = IP(str(p))
</code></pre><h2 id=setup-sa>setup SA</h2><pre><code>&gt;&gt;&gt; sa = SecurityAssociation(ESP, spi=0xdeadbeef, crypt_algo='AES-CBC',crypt_key='sixteenbytes key')
</code></pre><h2 id=encrypt-wo-iv>Encrypt w/o IV</h2><pre><code>&gt;&gt;&gt; e = sa.encrypt(p, 5)
&gt;&gt;&gt; e
&lt;IP  version=4L ihl=5L tos=0x0 len=76 id=1 flags= frag=0L ttl=64 proto=esp chksum=0x747a src=1.1.1.1 dst=2.2.2.2 |&lt;ESP  spi=0xdeadbeef seq=5 data='uD\x7fdj19\xe7\xc4\xff8\x10\xcdQ\xf0\xa6\x1e!\x84\xc3&gt;!\x18\xa6\xf6\xb8\x93\xc6it\x9a\xfc\x1c\xee\xe5C\xcd\xf0\x7fD\xca\x8d\xadKh\xa8\xe5x' |&gt;&gt;
&gt;&gt;&gt; e.show()
###[ IP ]###
  version   = 4L
  ihl       = 5L
  tos       = 0x0
  len       = 76
  id        = 1
  flags     = 
  frag      = 0L
  ttl       = 64
  proto     = esp
  chksum    = 0x747a
  src       = 1.1.1.1
  dst       = 2.2.2.2
  \options   \
###[ ESP ]###
     spi       = 0xdeadbeef
     seq       = 5
     data      = 'uD\x7fdj19\xe7\xc4\xff8\x10\xcdQ\xf0\xa6\x1e!\x84\xc3&gt;!\x18\xa6\xf6\xb8\x93\xc6it\x9a\xfc\x1c\xee\xe5C\xcd\xf0\x7fD\xca\x8d\xadKh\xa8\xe5x'
</code></pre><h2 id=encrypt-w-iv>Encrypt w/ IV</h2><pre><code>&gt;&gt;&gt; e = sa.encrypt(p, 5, &quot;1234567890123456&quot;)
&gt;&gt;&gt; e
&lt;IP  version=4L ihl=5L tos=0x0 len=76 id=1 flags= frag=0L ttl=64 proto=esp chksum=0x747a src=1.1.1.1 dst=2.2.2.2 |&lt;ESP  spi=0xdeadbeef seq=5 data='1234567890123456\xa4\x0b\xebZ\xa7\xc8\xb6\x95\xfb\x13\x07\xc5TD\xa2\xe7DP\xfcP\xa5y\xc4\x06W\xe8\xf5\xf0\x86\xe1\x0c\xfd' |&gt;&gt;
&gt;&gt;&gt; e.show()
###[ IP ]###
  version   = 4L
  ihl       = 5L
  tos       = 0x0
  len       = 76
  id        = 1
  flags     = 
  frag      = 0L
  ttl       = 64
  proto     = esp
  chksum    = 0x747a
  src       = 1.1.1.1
  dst       = 2.2.2.2
  \options   \
###[ ESP ]###
     spi       = 0xdeadbeef
     seq       = 5
     data      = '1234567890123456\xa4\x0b\xebZ\xa7\xc8\xb6\x95\xfb\x13\x07\xc5TD\xa2\xe7DP\xfcP\xa5y\xc4\x06W\xe8\xf5\xf0\x86\xe1\x0c\xfd'
</code></pre><p>data 의 시작 부분에 IV값 &lsquo;1234567890123456&rsquo;이 있음을 알 수 있다.
ESP는 SPI(4B), SEQ(4B), IV(16B) , Encrypted Data 형태로 구성된다.</p><p>만일 IV값의 길이가 틀리면 다음와 같이 에러 출력</p><pre><code>&gt;&gt;&gt; e = sa.encrypt(p, 5, &quot;1234567890&quot;)
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
  File &quot;ipsec.py&quot;, line 903, in encrypt
    return self._encrypt_esp(pkt, seq_num=seq_num, iv=iv)
  File &quot;ipsec.py&quot;, line 787, in _encrypt_esp
    raise TypeError('iv length must be %s' % self.crypt_algo.iv_size)
TypeError: iv length must be 16
</code></pre><h2 id=securityassocaition-옵션>SecurityAssocaition 옵션</h2><h3 id=1-tunnel_header>1. <code>tunnel_header</code></h3><p>Tunnel mode를 사용하려면 tunnel_header 인자로 outer IP header instance를 넘긴다.</p><pre><code>&gt;&gt;&gt; outer_ip = IP(src='10.10.10.10', dst='20.20.20.20')
&gt;&gt;&gt; sa = SecurityAssociation(ESP, spi=0xdeadbeef, crypt_algo='AES-CBC',crypt_key='sixteenbytes key', tunnel_header=outer_ip)
&gt;&gt;&gt; e = sa.encrypt(p, 5, &quot;1234567890123456&quot;)
&gt;&gt;&gt; e 
&lt;IP  version=4L ihl=5L tos=0x0 len=108 id=1 flags= frag=0L ttl=64 proto=esp chksum=0x3e24 src=10.10.10.10 dst=20.20.20.20 |&lt;ESP  spi=0xdeadbeef seq=5 data='1234567890123456`\xc6\xa9\xe9Q\x97-\xd6\xe5\x07\xb3\x85\xfb\xc9\xeaz\x07~\xfe\x14\xd1\x19\xd8F\x8cS\x10[\x8f\xfe\x93_ut\xef1\xc0\xc4|\xdb\xccH\xea\xf8\xd2\xd0jj\xeeD\x88\x80\xc5}U\xb5_x)\xaal/,\x96' |&gt;&gt;
&gt;&gt;&gt; e.show()
###[ IP ]###
  version   = 4L
  ihl       = 5L
  tos       = 0x0
  len       = 108
  id        = 1
  flags     = 
  frag      = 0L
  ttl       = 64
  proto     = esp
  chksum    = 0x3e24
  src       = 10.10.10.10
  dst       = 20.20.20.20
  \options   \
###[ ESP ]###
     spi       = 0xdeadbeef
     seq       = 5
     data      = '1234567890123456`\xc6\xa9\xe9Q\x97-\xd6\xe5\x07\xb3\x85\xfb\xc9\xeaz\x07~\xfe\x14\xd1\x19\xd8F\x8cS\x10[\x8f\xfe\x93_ut\xef1\xc0\xc4|\xdb\xccH\xea\xf8\xd2\xd0jj\xeeD\x88\x80\xc5}U\xb5_x)\xaal/,\x96'   
</code></pre><p>Tunnel mode를 사용하지 않은 경우와 별반 차이가 없어 보이지만, IP의 total length값이 기존 76바이에서 108바이트로 변경되었고, ESP data값도 달라졌다.
Tunnel mode의 경우 ESP data에 원본 패킷 전체가 포함되는 반면 Transport mode이 경우 L4 layer이상만 포함되므로 값이 달라진다.
IP total length의 경우 32바이트가 차이나는데 20 + 12 ???? FIMXE</p><h3 id=2-nat_t_header>2. <code>nat_t_header</code></h3><p>NAT traversal을 위해는 UDP encapsulation을 이용하는데 이 역시 SA 를 생성할 때 지정할 수 있다.
IP total length의 경우 추가된 8byte의 UDP header가 고려되어 108byte에서 116byte로 커졌다.</p><pre><code>&gt;&gt;&gt; nat_t_udp = UDP(dport=4500)            
&gt;&gt;&gt; sa = SecurityAssociation(ESP, spi=0xdeadbeef, crypt_algo='AES-CBC',crypt_key='sixteenbytes key', tunnel_header=outer_ip, nat_t_header=nat_t_udp)
&gt;&gt;&gt; e = sa.encrypt(p, 5, &quot;1234567890123456&quot;)
&gt;&gt;&gt; e
&lt;IP  version=4L ihl=5L tos=0x0 len=116 id=1 flags= frag=0L ttl=64 proto=udp chksum=0x3e3d src=10.10.10.10 dst=20.20.20.20 options=[] |&lt;UDP  sport=domain dport=ipsec_nat_t len=8 chksum=0x0 |&lt;ESP  spi=0xdeadbeef seq=5 data='1234567890123456`\xc6\xa9\xe9Q\x97-\xd6\xe5\x07\xb3\x85\xfb\xc9\xeaz\x07~\xfe\x14\xd1\x19\xd8F\x8cS\x10[\x8f\xfe\x93_ut\xef1\xc0\xc4|\xdb\xccH\xea\xf8\xd2\xd0jj\xeeD\x88\x80\xc5}U\xb5_x)\xaal/,\x96' |&gt;&gt;&gt;
&gt;&gt;&gt; e.show()
###[ IP ]###
  version   = 4L
  ihl       = 5L
  tos       = 0x0
  len       = 116
  id        = 1
  flags     = 
  frag      = 0L
  ttl       = 64
  proto     = udp
  chksum    = 0x3e3d
  src       = 10.10.10.10
  dst       = 20.20.20.20
  \options   \
###[ UDP ]###
     sport     = domain
     dport     = ipsec_nat_t
     len       = 8
     chksum    = 0x0
###[ ESP ]###
        spi       = 0xdeadbeef
        seq       = 5
        data      = '1234567890123456`\xc6\xa9\xe9Q\x97-\xd6\xe5\x07\xb3\x85\xfb\xc9\xeaz\x07~\xfe\x14\xd1\x19\xd8F\x8cS\x10[\x8f\xfe\x93_ut\xef1\xc0\xc4|\xdb\xccH\xea\xf8\xd2\xd0jj\xeeD\x88\x80\xc5}U\xb5_x)\xaal/,\x96'
</code></pre><hr><ul class=pager><li class=previous><a href=/post/2016/fragment-missing-test-with-scapy/ data-toggle=tooltip data-placement=top title="fragment missing test with scapy">&larr;
Previous Post</a></li><li class=next><a href=/post/2016/scapy-suppress-scapy-warning-message/ data-toggle=tooltip data-placement=top title="(Scapy) Suppress Scapy warning message">Next
Post &rarr;</a></li></ul><div id=disqus-comment></div></div><div class="col-lg-11 col-lg-offset-1
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/agile title=agile>agile</a>
<a href=/tags/amazon title=amazon>amazon</a>
<a href=/tags/amdocs title=amdocs>amdocs</a>
<a href=/tags/ansible title=ansible>ansible</a>
<a href=/tags/ansible-playbook title=ansible-playbook>ansible-playbook</a>
<a href=/tags/anti-work-pattern title=anti-work-pattern>anti-work-pattern</a>
<a href=/tags/apple title=apple>apple</a>
<a href=/tags/automation title=automation>automation</a>
<a href=/tags/backup title=backup>backup</a>
<a href=/tags/book title=book>book</a>
<a href=/tags/brew title=brew>brew</a>
<a href=/tags/calico title=calico>calico</a>
<a href=/tags/cisco title=cisco>cisco</a>
<a href=/tags/cni title=cni>cni</a>
<a href=/tags/coding-style title=coding-style>coding-style</a>
<a href=/tags/container title=container>container</a>
<a href=/tags/cron title=cron>cron</a>
<a href=/tags/cronjob title=cronjob>cronjob</a>
<a href=/tags/cuda title=cuda>cuda</a>
<a href=/tags/culture title=culture>culture</a>
<a href=/tags/dev-culture title=dev-culture>dev-culture</a>
<a href=/tags/docker title=docker>docker</a>
<a href=/tags/docker-compose title=docker-compose>docker-compose</a>
<a href=/tags/dpdk title=dpdk>dpdk</a>
<a href=/tags/elk title=elk>elk</a>
<a href=/tags/english title=english>english</a>
<a href=/tags/getting-started title=getting-started>getting-started</a>
<a href=/tags/ghost title=ghost>ghost</a>
<a href=/tags/git title=git>git</a>
<a href=/tags/github title=github>github</a>
<a href=/tags/golang title=golang>golang</a>
<a href=/tags/google title=google>google</a>
<a href=/tags/gpu title=gpu>gpu</a>
<a href=/tags/grafana title=grafana>grafana</a>
<a href=/tags/helm title=helm>helm</a>
<a href=/tags/homebrew title=homebrew>homebrew</a>
<a href=/tags/http title=http>http</a>
<a href=/tags/hugo title=hugo>hugo</a>
<a href=/tags/influxdb title=influxdb>influxdb</a>
<a href=/tags/intel title=intel>intel</a>
<a href=/tags/ipad title=ipad>ipad</a>
<a href=/tags/iphone title=iphone>iphone</a>
<a href=/tags/ipsec title=ipsec>ipsec</a>
<a href=/tags/json title=json>json</a>
<a href=/tags/kubernetes title=kubernetes>kubernetes</a>
<a href=/tags/life title=life>life</a>
<a href=/tags/lifehack title=lifehack>lifehack</a>
<a href=/tags/mac-mini-2009 title=mac-mini-2009>mac-mini-2009</a>
<a href=/tags/manager title=manager>manager</a>
<a href=/tags/monitoring title=monitoring>monitoring</a>
<a href=/tags/mysql title=mysql>mysql</a>
<a href=/tags/nfv title=nfv>nfv</a>
<a href=/tags/nginx title=nginx>nginx</a>
<a href=/tags/note title=note>note</a>
<a href=/tags/odp title=odp>odp</a>
<a href=/tags/onap title=onap>onap</a>
<a href=/tags/onp title=onp>onp</a>
<a href=/tags/openstack title=openstack>openstack</a>
<a href=/tags/opnfv title=opnfv>opnfv</a>
<a href=/tags/osx title=osx>osx</a>
<a href=/tags/ovdk title=ovdk>ovdk</a>
<a href=/tags/ovs title=ovs>ovs</a>
<a href=/tags/photo title=photo>photo</a>
<a href=/tags/podcast title=podcast>podcast</a>
<a href=/tags/programming title=programming>programming</a>
<a href=/tags/protocol-buffer title=protocol-buffer>protocol-buffer</a>
<a href=/tags/python title=python>python</a>
<a href=/tags/scapy title=scapy>scapy</a>
<a href=/tags/sdn title=sdn>sdn</a>
<a href=/tags/slack title=slack>slack</a>
<a href=/tags/sw-%EA%B0%9C%EB%B0%9C-%EB%AC%B8%ED%99%94 title=sw-개발-문화>sw-개발-문화</a>
<a href=/tags/team title=team>team</a>
<a href=/tags/telemetry title=telemetry>telemetry</a>
<a href=/tags/til title=til>til</a>
<a href=/tags/troubleshooting title=troubleshooting>troubleshooting</a>
<a href=/tags/ubuntu title=ubuntu>ubuntu</a>
<a href=/tags/vagrant title=vagrant>vagrant</a>
<a href=/tags/virtualization title=virtualization>virtualization</a>
<a href=/tags/vmware title=vmware>vmware</a>
<a href=/tags/vnf title=vnf>vnf</a>
<a href=/tags/vran title=vran>vran</a>
<a href=/tags/wordpress title=wordpress>wordpress</a>
<a href=/tags/%EA%B3%B5%EB%B6%80 title=공부>공부</a>
<a href=/tags/%EA%B4%80%EB%A6%AC%EB%8A%A5%EB%A0%A5 title=관리능력>관리능력</a>
<a href=/tags/%EA%B8%B0%EB%A1%9D title=기록>기록</a>
<a href=/tags/%EB%A6%AC%EB%8D%94 title=리더>리더</a>
<a href=/tags/%EB%AC%B8%ED%99%94 title=문화>문화</a>
<a href=/tags/%EC%83%9D%EC%82%B0%EC%84%B1 title=생산성>생산성</a>
<a href=/tags/%EC%9E%A1%EC%83%9D%EA%B0%81 title=잡생각>잡생각</a>
<a href=/tags/%EC%A1%B0%EC%A7%81%EA%B4%80%EB%A6%AC title=조직관리>조직관리</a>
<a href=/tags/%ED%9A%8C%EC%9D%98 title=회의>회의</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href rel=alternate type=application/rss+xml title="Keep calm and write something"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a href=mailto:youremail@gmail.com><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/your%20wechat%20qr%20code%20image><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-wechat fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/yourgithub><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/yourlinkedinid><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://stackoverflow.com/users/yourstackoverflowid><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Keep calm and write something 2020<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function async(u,c){var d=document,t='script',o=d.createElement(t),s=d.getElementsByTagName(t)[0];o.src=u;if(c){o.addEventListener('load',function(e){c(null,e);},false);}
s.parentNode.insertBefore(o,s);}</script><script>if($('#tag_cloud').length!==0){async("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:'#bbbbee',end:'#0085a1'},};$('#tag_cloud a').tagcloud();})}</script><script>async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js",function(){var $nav=document.querySelector("nav");if($nav)FastClick.attach($nav);})</script></body></html>