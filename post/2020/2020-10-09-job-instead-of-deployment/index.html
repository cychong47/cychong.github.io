<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Keep calm and write something"><meta property="og:type" content="article"><meta property="og:image" content="https://cychong47.github.io/images/another_blog_bg.jpg"><meta property="twitter:image" content="https://cychong47.github.io/images/another_blog_bg.jpg"><meta name=title content="일회성 앱은 Deployment가 아닌 Job으로"><meta property="og:title" content="일회성 앱은 Deployment가 아닌 Job으로"><meta property="twitter:title" content="일회성 앱은 Deployment가 아닌 Job으로"><meta name=description content><meta property="og:description" content><meta property="twitter:description" content><meta property="twitter:card" content="summary"><meta name=keyword content="Blog, cychong, Kubernetes, dpdk"><link rel="shortcut icon" href=/img/favicon.ico><title>일회성 앱은 Deployment가 아닌 Job으로-another blog</title><link rel=canonical href=/post/2020/2020-10-09-job-instead-of-deployment/><link rel=stylesheet href=/css/iDisqus.min.css><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hux-blog.min.css><link rel=stylesheet href=/css/zanshang.css><link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css rel=stylesheet type=text/css><link rel=stylesheet href=https://cychong47.github.io/css/custom-cleanwhite.css><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/hux-blog.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=/>Keep calm and write something</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>Home</a></li><li><a href=/categories/book>book</a></li><li><a href=/categories/gadget>gadget</a></li><li><a href=/categories/hugo>hugo</a></li><li><a href=/categories/kubernetes>kubernetes</a></li><li><a href=/categories/life>life</a></li><li><a href=/categories/note>note</a></li><li><a href=/categories/til>til</a></li><li><a href=/search>SEARCH <img src=/img/search.png height=15 style=cursor:pointer alt=Search></a></li></ul></div></div></div></nav><script>var $body=document.body;var $toggle=document.querySelector('.navbar-toggle');var $navbar=document.querySelector('#huxblog_navbar');var $collapse=document.querySelector('.navbar-collapse');$toggle.addEventListener('click',handleMagic)
function handleMagic(e){if($navbar.className.indexOf('in')>0){$navbar.className=" ";setTimeout(function(){if($navbar.className.indexOf('in')<0){$collapse.style.height="0px"}},400)}else{$collapse.style.height="auto"
$navbar.className+=" in";}}</script><style type=text/css>header.intro-header{background-image:url(/images/another_blog_bg.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/kubernetes title=kubernetes>kubernetes</a>
<a class=tag href=/tags/job title=job>job</a></div><h1>일회성 앱은 Deployment가 아닌 Job으로</h1><h2 class=subheading></h2><span class=meta>Posted by
Keep calm and write something
on
Friday, October 9, 2020</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-11 col-lg-offset-1
col-md-10 col-md-offset-1
post-container"><header><h2>TOC</h2></header><nav id=TableOfContents><ul><li><ul><li><a href=#use-job-instead-of-deployment>Use <code>Job</code> instead of <code>Deployment</code></a></li><li><a href=#mysqldump-vs-mysql><code>mysqldump</code> vs. <code>mysql</code></a></li><li><a href=#jobyaml><code>job.yaml</code></a></li></ul></li></ul></nav><p>한 번 실행되면 데몬 처럼 계속해서 동작하는 앱이 아니라 필요한 일을 수행하고 종료되는 앱도 있다. 실행된 시점에 필요한 일을 수행하고 종료하는 형태로 예를 들면 특정 위치에 있는 파일을 처리하고 종료한다거나, 실행된 시점에 외부 서비스에서 필요한 정보를 가져와 어딘가 저장하는 등의 일을 하는. 이런 종류의 앱을 kubernetes에서 <code>Deployment</code>로 배포한 경우 해당 앱은 자신이 해야 할 일을 정상적으로 수행하고 종료되지만, kubernetes scheduler 입장에서는 해당 container가 (의도하지 않게) 종료된 것으로 판단하여 다시 복구하는 절차를 수행한다. 이는 <code>Deployment</code>로 배포된 container는 scheduler를 통해 배포된 것처럼 scheduler를 통해 제거되지 않으면 비정상이라고 판단하기 때문이다.</p><p>이때 만일 복구하는데 한도를 두지 않으면 계속해서 앱이 실행되었다 종료되고, 다시 복구되는 작업을 반복하게 되는데 이는 불필요한 에러 로그만 지속적으로 생산하는 상황이 된다.</p><h2 id=use-job-instead-of-deployment>Use <code>Job</code> instead of <code>Deployment</code></h2><p>만일 앱이 실행된 후 필요한 일을 모두 마치고 종료되는 것이 의도된 동작이라면 해당 Pod의 <code>kind</code>를 <code>Deployment</code>가 아니라 <code>Job</code> 형태로 정의한다.</p><p>다만 <code>Job</code>을 이용한 chart를 준비할 때 사소한 이슈라면 <code>helm create</code> 명령으로 만들어진 helm chart template는 기본적으로 <code>Deployment</code>와 <code>Service</code>등만 만들어 <code>Job</code> 을 위한 YAML 파일을 만들 쉬운 방법이 없다는 점이다.(<code>helm create</code> 명령의 도움말이나 구글링 결과, 2020.10월 기준)</p><p>대부분 <code>Job</code>에 대해 설명하는 문서에서는 간단한 YAML 파일을 기준으로 설명하고 있어, helm chart를 사용해서 배포하려는 경우에는 어떻게 chart를 만들어야 할 지 난감하다.</p><h2 id=mysqldump-vs-mysql><code>mysqldump</code> vs. <code>mysql</code></h2><p>다행히 <code>github</code>에 있는 공식 helm chart를 보면 많은 기여자들이 만든 좋은 예제를 참조할 수 있다.(이것도 역시 open-source가 주는 장점)
그래서 <code>Job</code> 키워드로 검색을 해 보니 몇 개의 chart가 이를 사용하는 것으로 확인되었다. 그 중에 하나 고른 것이 <code>mysqldump</code>.
이름 그래도 <code>mysql</code>의 database를 백업하는 툴 같은데, <code>mysql shell</code>을 이용하거나 API를 이용해서 DB에 연결해서 정보를 백업하는 형태일 것 같다.</p><p>이때 서버 역할을 할 <code>mysql</code>은 당연히 늘 실행되어 있는 형태일 거라 일반적인 <code>Deployment</code>를 사용할 듯 하고.
그래서 <code>Job</code>을 사용하는 <code>mysqldump</code> chart와 <code>Deployment</code>를 사용하는 <code>mysql</code>의 chart를 비교해 보면 <code>Job</code>을 사용하는 chart를 어떻게 만들면 되는 지 감을 잡을 수 있을 듯 하다.</p><h3 id=jobyaml-instead-of-deploymentyaml><code>job.yaml</code> instead of <code>deployment.yaml</code></h3><p><code>mysqldump</code>의 경우 <code>deployment.yaml</code> 대신 <code>job.yaml</code> 파일과 <code>cron.yaml</code> 파일을 가지고 있었다. 그 외 <code>configmap</code>은 <code>mysql</code>과 <code>mysqldump</code>에서 파일 이름만 다를 뿐 양쪽에서 모두 사용하고 있으므로 차이점은 아니고.</p><pre><code>cychong@mini1:~/work/Helm/reference/official-helm-charts/stable/mysqldump/templates$ ls -al
total 44
drwxrwxr-x 2 cychong cychong 4096 Oct  9 09:12 .
drwxrwxr-x 4 cychong cychong 4096 Sep 20  2019 ..
-rw-rw-r-- 1 cychong cychong 1934 Sep 20  2019 NOTES.txt
-rw-rw-r-- 1 cychong cychong 1869 Sep 20  2019 _helpers.tpl
-rwxrwxr-x 1 cychong cychong 5478 Sep 20  2019 configmap.yaml
-rw-rw-r-- 1 cychong cychong  806 Sep 20  2019 cron.yaml
-rw-rw-r-- 1 cychong cychong  691 Sep 20  2019 gcpserviceaccount.yaml
-rw-rw-r-- 1 cychong cychong  298 Sep 20  2019 job.yaml
-rw-rw-r-- 1 cychong cychong  625 Sep 20  2019 pvc.yaml
-rw-rw-r-- 1 cychong cychong 1238 Sep 20  2019 secret.yaml

cychong@mini1:~/work/Helm/reference/official-helm-charts/stable/mysq/templates/ls -al
total 52
drwxrwxr-x 3 cychong cychong 4096 Sep 20  2019 .
drwxrwxr-x 3 cychong cychong 4096 Sep 20  2019 ..
-rw-rw-r-- 1 cychong cychong 1797 Sep 20  2019 NOTES.txt
-rw-rw-r-- 1 cychong cychong  989 Sep 20  2019 _helpers.tpl
-rw-rw-r-- 1 cychong cychong  292 Sep 20  2019 configurationFiles-configmap.yaml
-rw-rw-r-- 1 cychong cychong 8137 Sep 20  2019 deployment.yaml
-rw-rw-r-- 1 cychong cychong  295 Sep 20  2019 initializationFiles-configmap.yaml
-rw-rw-r-- 1 cychong cychong  868 Sep 20  2019 pvc.yaml
-rwxrwxr-x 1 cychong cychong 1245 Sep 20  2019 secrets.yaml
-rw-rw-r-- 1 cychong cychong  800 Sep 20  2019 servicemonitor.yaml
-rw-rw-r-- 1 cychong cychong 1104 Sep 20  2019 svc.yaml
drwxrwxr-x 2 cychong cychong 4096 Sep 20  2019 tests
</code></pre><h2 id=jobyaml><code>job.yaml</code></h2><p>한번 실행되면 명시적으로 중지시키지 않는 이상 계속해서 실행되는 <code>deployment</code>와 달리 한번 실행되어 필요한 작업을 완료한 후 종료되는 app은 <code>kind</code>를 <code>Deployment</code>가 아닌 <code>Job</code>으로 지정한다.</p><pre><code>$ helm install -f pocket-stat-value.yaml pocket-stat helm-chart/charts/pocket-stat
NAME: pocket-stat
LAST DEPLOYED: Fri Oct  9 16:24:22 2020
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath=&quot;{.spec.ports[0].nodePort}&quot; services pocket-stat)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath=&quot;{.items[0].status.addresses[0].address}&quot;)
  echo http://$NODE_IP:$NODE_PORT
</code></pre><p><code>Job</code> 타입의 정보는 <code>kubectl get jobs</code> 명령으로 확인할 수 있다.</p><pre><code>$ kubectl get jobs
NAME          COMPLETIONS   DURATION   AGE
pocket-stat   0/1           6s         6s
</code></pre><p>그리고 해당 <code>Job</code>에서 생성했던 <code>Pod</code> 역시 아래와 같이 <code>kubectl get pods</code>명령으로 확인이 가능한데, 다른 <code>Deployment</code> 형태의 Pod와 달리 <code>STATUS</code>가 <code>Completed</code>임을 알 수 있다. 즉 필요한 일을 마치 종료되었는데 이를 말 그대로 “Complete” 된 것으로 판단하고, 다시 재실행시키지 않는다는 의미이다.</p><pre><code>$ kubectl get pods
NAME                             READY   STATUS      RESTARTS   AGE
grafana-6b66fb5758-gmvgf         1/1     Running     1          4d17h
influxdb-0                       1/1     Running     1          6d6h
pocket-stat-ksrvr                0/1     Completed   0          12s
podcast-nginx-659bcb6485-ps7qq   1/1     Running     1          6d7h
sosa0sa-nginx-87fc9949c-wb4jp    1/1     Running     1          6d7h
</code></pre><p>Pod의 실행 결과는 여느 Pod 와 동일하게 <code>kubectl logs</code> 명령으로 확인 가능.</p><pre><code>$ kubectl logs pocket-stat-ksrvr
Check articles added since 2020-10-08 00:00:00
16 are collected in yesterday
</code></pre><hr><ul class=pager><li class=previous><a href=/post/2020/2020-10-04-install-influxdb-grafana-with-helm/ data-toggle=tooltip data-placement=top title="Install Influxdb and Grafana With Helm">&larr;
Previous Post</a></li><li class=next><a href=/post/2020/2020-10-09-cronjob-in-kubernetes/ data-toggle=tooltip data-placement=top title="주기적으로 실행되는 앱은 CronJob으로">Next
Post &rarr;</a></li></ul><div id=disqus-comment></div></div><div class="col-lg-11 col-lg-offset-1
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/agile title=agile>agile</a>
<a href=/tags/amazon title=amazon>amazon</a>
<a href=/tags/amdocs title=amdocs>amdocs</a>
<a href=/tags/ansible title=ansible>ansible</a>
<a href=/tags/ansible-playbook title=ansible-playbook>ansible-playbook</a>
<a href=/tags/anti-work-pattern title=anti-work-pattern>anti-work-pattern</a>
<a href=/tags/apple title=apple>apple</a>
<a href=/tags/automation title=automation>automation</a>
<a href=/tags/backup title=backup>backup</a>
<a href=/tags/book title=book>book</a>
<a href=/tags/brew title=brew>brew</a>
<a href=/tags/calico title=calico>calico</a>
<a href=/tags/cisco title=cisco>cisco</a>
<a href=/tags/cni title=cni>cni</a>
<a href=/tags/coding-style title=coding-style>coding-style</a>
<a href=/tags/container title=container>container</a>
<a href=/tags/cron title=cron>cron</a>
<a href=/tags/cronjob title=cronjob>cronjob</a>
<a href=/tags/cuda title=cuda>cuda</a>
<a href=/tags/culture title=culture>culture</a>
<a href=/tags/dev-culture title=dev-culture>dev-culture</a>
<a href=/tags/docker title=docker>docker</a>
<a href=/tags/docker-compose title=docker-compose>docker-compose</a>
<a href=/tags/dpdk title=dpdk>dpdk</a>
<a href=/tags/elk title=elk>elk</a>
<a href=/tags/english title=english>english</a>
<a href=/tags/getting-started title=getting-started>getting-started</a>
<a href=/tags/ghost title=ghost>ghost</a>
<a href=/tags/git title=git>git</a>
<a href=/tags/github title=github>github</a>
<a href=/tags/golang title=golang>golang</a>
<a href=/tags/google title=google>google</a>
<a href=/tags/gpu title=gpu>gpu</a>
<a href=/tags/grafana title=grafana>grafana</a>
<a href=/tags/helm title=helm>helm</a>
<a href=/tags/homebrew title=homebrew>homebrew</a>
<a href=/tags/http title=http>http</a>
<a href=/tags/hugo title=hugo>hugo</a>
<a href=/tags/influxdb title=influxdb>influxdb</a>
<a href=/tags/intel title=intel>intel</a>
<a href=/tags/ipad title=ipad>ipad</a>
<a href=/tags/iphone title=iphone>iphone</a>
<a href=/tags/ipsec title=ipsec>ipsec</a>
<a href=/tags/json title=json>json</a>
<a href=/tags/kubernetes title=kubernetes>kubernetes</a>
<a href=/tags/life title=life>life</a>
<a href=/tags/lifehack title=lifehack>lifehack</a>
<a href=/tags/mac-mini-2009 title=mac-mini-2009>mac-mini-2009</a>
<a href=/tags/manager title=manager>manager</a>
<a href=/tags/monitoring title=monitoring>monitoring</a>
<a href=/tags/mysql title=mysql>mysql</a>
<a href=/tags/nfv title=nfv>nfv</a>
<a href=/tags/nginx title=nginx>nginx</a>
<a href=/tags/note title=note>note</a>
<a href=/tags/odp title=odp>odp</a>
<a href=/tags/onap title=onap>onap</a>
<a href=/tags/onp title=onp>onp</a>
<a href=/tags/openstack title=openstack>openstack</a>
<a href=/tags/opnfv title=opnfv>opnfv</a>
<a href=/tags/osx title=osx>osx</a>
<a href=/tags/ovdk title=ovdk>ovdk</a>
<a href=/tags/ovs title=ovs>ovs</a>
<a href=/tags/photo title=photo>photo</a>
<a href=/tags/podcast title=podcast>podcast</a>
<a href=/tags/programming title=programming>programming</a>
<a href=/tags/protocol-buffer title=protocol-buffer>protocol-buffer</a>
<a href=/tags/python title=python>python</a>
<a href=/tags/scapy title=scapy>scapy</a>
<a href=/tags/sdn title=sdn>sdn</a>
<a href=/tags/slack title=slack>slack</a>
<a href=/tags/sw-%EA%B0%9C%EB%B0%9C-%EB%AC%B8%ED%99%94 title=sw-개발-문화>sw-개발-문화</a>
<a href=/tags/team title=team>team</a>
<a href=/tags/telemetry title=telemetry>telemetry</a>
<a href=/tags/til title=til>til</a>
<a href=/tags/troubleshooting title=troubleshooting>troubleshooting</a>
<a href=/tags/ubuntu title=ubuntu>ubuntu</a>
<a href=/tags/vagrant title=vagrant>vagrant</a>
<a href=/tags/virtualization title=virtualization>virtualization</a>
<a href=/tags/vmware title=vmware>vmware</a>
<a href=/tags/vnf title=vnf>vnf</a>
<a href=/tags/vran title=vran>vran</a>
<a href=/tags/wordpress title=wordpress>wordpress</a>
<a href=/tags/%EA%B3%B5%EB%B6%80 title=공부>공부</a>
<a href=/tags/%EA%B4%80%EB%A6%AC%EB%8A%A5%EB%A0%A5 title=관리능력>관리능력</a>
<a href=/tags/%EA%B8%B0%EB%A1%9D title=기록>기록</a>
<a href=/tags/%EB%A6%AC%EB%8D%94 title=리더>리더</a>
<a href=/tags/%EB%AC%B8%ED%99%94 title=문화>문화</a>
<a href=/tags/%EC%83%9D%EC%82%B0%EC%84%B1 title=생산성>생산성</a>
<a href=/tags/%EC%9E%A1%EC%83%9D%EA%B0%81 title=잡생각>잡생각</a>
<a href=/tags/%EC%A1%B0%EC%A7%81%EA%B4%80%EB%A6%AC title=조직관리>조직관리</a>
<a href=/tags/%ED%9A%8C%EC%9D%98 title=회의>회의</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href rel=alternate type=application/rss+xml title="Keep calm and write something"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a href=mailto:cychong@gmail.com><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Keep calm and write something 2021<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function async(u,c){var d=document,t='script',o=d.createElement(t),s=d.getElementsByTagName(t)[0];o.src=u;if(c){o.addEventListener('load',function(e){c(null,e);},false);}
s.parentNode.insertBefore(o,s);}</script><script>if($('#tag_cloud').length!==0){async("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:'#bbbbee',end:'#0085a1'},};$('#tag_cloud a').tagcloud();})}</script><script>async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js",function(){var $nav=document.querySelector("nav");if($nav)FastClick.attach($nav);})</script></body></html>